/* Copyright Stefan Luger: Refinery's Provenance Visualization */
var refineryProvVis=function(e,t,n,a){"use strict";function i(e){this.node=e,this.doiTime=0,this.doiLayerDiff=0,this.change={wfParams:t.map(),files:t.map(),topology:t.map()},this.relationship=0,this.graphMetrics={width:-1,height:-1},this.doiFiltered=0,this.doiSelected=0,this.doiHighlighted=0,this.neighborhoodDoiFactor=1,this.doiMinMax=-1,this.doiWeightedSum=-1}function r(e,n,a,s){this.id=e,this.nodeType=n,this.parent=a,this.hidden=s,this.preds=t.map(),this.succs=t.map(),this.predLinks=t.map(),this.succLinks=t.map(),this.children=t.map(),this.x=0,this.y=0,this.l={ts:{removed:!1},width:0,depth:0,bcOrder:-1},r.numInstances=(r.numInstances||0)+1,this.autoId=r.numInstances,this.doi=new i(this),this.selected=!1,this.filtered=!0}function s(e,n,a,i,s,l,o,d,c,u,f,h,p){r.call(this,e,n,a,i),this.name=s,this.label="",this.fileType=l,this.study=o,this.assay=d,this.parents=c,this.analysis=u,this.subanalysis=f,this.uuid=h,this.fileUrl=p,this.attributes=t.map()}function l(e,n,a,i,s,l,o,d,c){r.call(this,e,"analysis",n,a),this.uuid=i,this.wfUuid=s,this.analysis=l,this.start=o,this.end=d,this.created=c,this.inputs=t.map(),this.outputs=t.map(),this.links=t.map(),this.wfName="",this.wfCode="",this.layer="",this.motif="",this.exaggerated=!1,this.motifDiff={numIns:0,numOuts:0,wfUuid:this.wfUuid,numSubanalyses:0}}function o(e,n,a,i){r.call(this,e,"subanalysis",n,a),this.subanalysis=i,this.wfUuid="",this.inputs=t.map(),this.outputs=t.map(),this.links=t.map()}function d(){this.preds=t.map(),this.succs=t.map(),this.numIns=0,this.numOuts=0,this.wfUuid="",this.numSubanalyses=0,this.file="",d.numInstances=(d.numInstances||0)+1,this.autoId=d.numInstances}function c(e,n,a,i){r.call(this,e,"layer",a,i),this.inputs=t.map(),this.outputs=t.map(),this.links=t.map(),this.motif=n,this.wfName=""}function u(e,t,n,a){this.id=e,this.source=t,this.target=n,this.hidden=a,this.highlighted=!1,this.filtered=!0,this.l={ts:{removed:!1}},u.numInstances=(u.numInstances||0)+1,this.autoId=u.numInstances}function f(e,t,n,a,i,r,s,l,o,d,c,u,f,h){this._parentDiv=e,this.zoom=t,this._data=n,this._url=a,this.canvas=i,this.rect=r,this.margin=s,this.width=l,this.height=o,this.radius=d,this.color=c,this.graph=u,this.cell=f,this.layerMethod=h}function h(e,n,a,i,r,s,l,o,d,c,u,f,h){this.dataset=e,this.nodes=n,this.links=a,this.aLinks=i,this.iNodes=r,this.oNodes=s,this.aNodes=l,this.saNodes=o,this.bclgNodes=[],this.analysisWorkflowMap=d,this.nodeMap=c,this.analysisData=u,this.workflowData=f,this.nodeData=h,this.l={width:0,depth:0},this.lNodes=t.map(),this.lLinks=t.map()}function p(e){var t="";switch(e.type){case"Source Name":case"Sample Name":case"Assay Name":t="special";break;case"Data Transformation Name":t="dt";break;default:t=null===e.file_url?"intermediate":"stored"}return t}function v(e,t,n){var a=null!==e.study?e.study.replace(/\/api\/v1\/study\//g,"").replace(/\//g,""):"",i=null!==e.assay?e.assay.replace(/\/api\/v1\/assay\//g,"").replace(/\//g,""):"",r=e.parents.map(function(e){return e.replace(/\/api\/v1\/node\//g,"").replace(/\//g,"")}),l=null!==e.analysis_uuid?e.analysis_uuid:"dataset",o="undefined";return"undefined"!=typeof e.name&&(o=e.name),new s(n,t,Object.create(null),!0,o,e.type,a,i,r,l,e.subanalysis,e.uuid,e.file_url)}function g(e){t.values(e.value).forEach(function(e,t){var n=p(e),a=v(e,n,t);pt.push(a),kt.set(e.uuid,a),Et.set(e.uuid,e)})}function m(e,t,n){return new u(e,t,n,!0)}function y(){var e=0;pt.forEach(function(t){"undefined"!=typeof t.uuid?"undefined"!=typeof t.parents?t.parents.forEach(function(n){"undefined"!=typeof kt.get(n)?(vt.push(m(e,kt.get(n),t)),e++):console.log("ERROR: Dataset might be corrupt - parent: "+n+" of node with uuid: "+t.uuid+" does not exist.")}):console.log("Error: Parents array of node with uuid: "+t.uuid+" is undefined!"):console.log("Error: Node uuid is undefined!")})}function x(){vt.forEach(function(e){e.source.succs.set(e.target.autoId,e.target),e.source.succLinks.set(e.autoId,e),e.target.preds.set(e.source.autoId,e.source),e.target.predLinks.set(e.autoId,e)}),pt.forEach(function(e){e.succs.empty()?yt.push(e):e.preds.empty()&&mt.push(e)})}function b(){function e(t,a){var i=a;t.subanalysis=i,t.preds.size()>1&&t.preds.values().forEach(function(e){null===e.subanalysis&&n(e,i)}),t.succs.values().forEach(function(t){"dataset"!==t.analysis&&(null===t.subanalysis?t.succs.empty()||(i=t.succs.values()[0].subanalysis):i=t.subanalysis),e(t,i)})}var t=0,n=function a(t,n){t.subanalysis=n,t.preds.values().forEach(function(e){null===e.subanalysis&&a(e,n)}),t.succs.values().forEach(function(t){null===t.subanalysis&&e(t,n)})};mt.forEach(function(n){null===n.subanalysis&&(e(n,t),t++)})}function I(e,t){var n={start:e.time_start,end:e.time_end,created:e.creation_date};return 19===n.start.length?n.start=n.start.concat(".000"):26===n.start.length&&(n.start=n.start.substr(0,n.start.length-3)),19===n.end.length?n.end=n.end.concat(".000"):26===n.end.length&&(n.end=n.end.substr(0,n.end.length-3)),19===n.created.length?n.created=n.created=n.created.concat(".000"):26===n.created.length&&(n.created=n.created.substr(0,n.created.length-3)),new l(t,Object.create(null),!0,e.uuid,e.workflow__uuid,t,n.start,n.end,n.created)}function k(e){e.forEach(function(e){var t=function(e){var t=e.replace(/u'/g,'"');return t=t.replace(/\'/g,'"'),t=t.replace(/\sNone/g,' "None"'),t=t.replace(/\\n/g,""),t=t.replace(/\\/g,""),t=t.replace(/\"{\"/g,'{"'),t=t.replace(/}\"/g,"}"),t=t.replace(/\"\"(\S+)\"\"/g,'"$1"'),t=t.replace(/\"__(\S*)__\":\s{1}\d*(,\s{1})?/g,""),t=t.replace(/,\s{1}null/g,""),t=t.replace(/null,/g,""),t=t.replace(/,\s{1}}/g,"}")},n=t(e.workflow_copy),a=JSON.parse(n),i=a;wt.set(e.workflow__uuid,i)})}function L(e){var n=t.time.format.iso(new Date(0));e.length>0&&(n=t.min(e,function(e){return new Date(e.time_start)}),n.setSeconds(n.getSeconds()-1),n=t.time.format.iso(n)),n=n.substr(0,n.length-1),Nt=new l(0,Object.create(null),!0,"dataset","dataset",0,n,n,n),xt.push(Nt),Lt.set("dataset","dataset"),e.forEach(function(e,t){xt.push(I(e,t+1)),Lt.set(e.uuid,e.workflow__uuid),Bt.set(e.uuid,e)})}function w(e,t,n){return new o(e,t,!0,n)}function B(){var e=0;xt.forEach(function(t){pt.filter(function(e){return e.analysis===t.uuid}).forEach(function(n){if(!t.children.has(n.subanalysis)){var a=w(e,t,n.subanalysis);bt.push(a),t.children.set(n.subanalysis,a),e++}})}),bt.forEach(function(e){pt.filter(function(t){return e.parent.uuid===t.analysis&&t.subanalysis===e.subanalysis}).forEach(function(t){return e.children.set(t.autoId,t)}),e.children.values().forEach(function(t){t.parent=e}),e.children.values().filter(function(t){return t.preds.values().some(function(t){return t.analysis!==e.parent.uuid})||t.preds.empty()}).forEach(function(t){return e.inputs.set(t.autoId,t)}),e.children.values().filter(function(t){return t.succs.empty()||t.succs.values().some(function(t){return t.analysis!==e.parent.uuid})}).forEach(function(t){e.outputs.set(t.autoId,t)})}),bt.forEach(function(e){e.inputs.values().forEach(function(t){t.preds.values().forEach(function(t){e.preds.has(t.parent.autoId)||e.preds.set(t.parent.autoId,t.parent)})}),e.outputs.values().forEach(function(t){t.succs.values().forEach(function(t){e.succs.has(t.parent.autoId)||e.succs.set(t.parent.autoId,t.parent)})})}),bt.forEach(function(e){e.inputs.values().forEach(function(t){t.predLinks.values().forEach(function(t){e.predLinks.set(t.autoId,t)})}),e.outputs.values().forEach(function(t){t.succLinks.values().forEach(function(t){e.succLinks.set(t.autoId,t)})})}),bt.forEach(function(e){vt.filter(function(t){return null!==t&&e.parent.uuid===t.source.analysis&&t.source.subanalysis===e.subanalysis}).forEach(function(t){e.parent.uuid===t.target.analysis?e.links.set(t.autoId,t):gt.push(t)})}),xt.forEach(function(e){e.children.values().forEach(function(t){t.inputs.entries().forEach(function(t){e.inputs.set(t.key,t.value)}),t.outputs.entries().forEach(function(t){e.outputs.set(t.key,t.value)}),t.wfUuid=e.wfUuid});var t=wt.get(e.wfUuid);e.wfName="undefined"==typeof t?"dataset":t.name,"Test workflow: "===e.wfName.substr(0,15)&&(e.wfName=e.wfName.substr(15,e.wfName.length-15)),e.wfName.indexOf("(")>0&&(e.wfName=e.wfName.substr(0,e.wfName.indexOf("("))),e.wfName.indexOf("-")>0&&(e.wfName=e.wfName.substr(0,e.wfName.indexOf("-"))),e.wfCode=e.wfName}),xt.forEach(function(e){e.children.values().forEach(function(t){t.preds.values().forEach(function(t){e.preds.has(t.parent.autoId)||e.preds.set(t.parent.autoId,t.parent)})}),e.children.values().forEach(function(t){t.succs.values().forEach(function(t){e.succs.has(t.parent.autoId)||e.succs.set(t.parent.autoId,t.parent)})})}),xt.forEach(function(e){e.children.values().forEach(function(t){t.links.values().forEach(function(t){e.links.set(t.autoId,t)})})}),xt.forEach(function(e){e.inputs.values().forEach(function(t){t.predLinks.values().forEach(function(t){e.predLinks.set(t.autoId,t)})}),e.outputs.values().forEach(function(t){t.succLinks.values().forEach(function(t){e.succLinks.set(t.autoId,t)})})})}function E(e){e instanceof n&&e.getDocumentList().forEach(function(e){var n=kt.get(e.uuid),a=t.entries(e);a.forEach(function(e){var t=e.key.indexOf("_Characteristics_"),a="";-1===t?(a=e.key.replace(/REFINERY_/g,""),a=a.replace(/_([0-9])+_([0-9])+_s/g,""),a=a.toLowerCase()):a=e.key.substr(0,t),n.attributes.set(a,e.value)})})}function N(a){if(a instanceof n&&a.getDocumentList().length>0){var i=a.getDocumentList()[0],r=t.entries(i);r.forEach(function(e){var t=e.key.indexOf("_Characteristics_"),n="";-1===t?(n=e.key.replace(/REFINERY_/g,""),n=n.replace(/_([0-9])+_([0-9])+_s/g,""),n=n.toLowerCase()):n=e.key.substr(0,t),It.push(n)})}It.forEach(function(t){e("<li/>",{id:"prov-ctrl-visible-attribute-list-"+t,style:"padding-left: 5px",html:'<a href="#" class="field-name"><label class="radio" style="text-align: start;margin-top: 0px;margin-bottom: 0px;"><input type="radio">'+t+"</label></a>"}).appendTo("#prov-ctrl-visible-attribute-list")}),e("#prov-ctrl-visible-attribute-list-name").find("input").prop("checked",!0)}function A(e){e.aNodes.forEach(function(t){t.parent=e})}function D(e,n,a){var i=t.entries(e)[1];g(i,a),y(),x(),L(n),k(n),b(),B(),E(a),N(a);var r=new h(Nt,pt,vt,gt,mt,yt,xt,bt,Lt,kt,Bt,wt,Et);return A(r),r}function T(e,t,n){return D(e,t,n)}function C(e,t,n){function a(t){var a=t;a instanceof s&&n instanceof h&&(a=a.parent.parent),a.succs.values().filter(function(e){return null===e.parent||e.parent===n}).forEach(function(t){var i=t;i instanceof s&&n instanceof h&&(i=i.parent.parent),i.predLinks.values().forEach(function(e){var t=null;a instanceof l?t=e.source instanceof l?e.source:e.source.parent.parent:a instanceof s&&(t=e.source),t&&t.autoId===a.autoId&&(e.l.ts.removed=!0)}),i.predLinks.values().some(function(e){return!e.l.ts.removed})||i.l.ts.removed||(e.push(i),i.l.ts.removed=!0)})}for(var i=[],r=0;r<e.length&&t>r;){var o=e[r];i.push(o),o.l.ts.removed=!0,a(o),r++}return e.length>t?null:i}function O(e,t){var n=0,a=[];e.forEach(function(e){e.preds.values().forEach(function(e){e.parent===t?a.push(e):e instanceof s&&t instanceof h&&a.push(e.parent.parent)}),0===a.length?e.col=n:!function(){var t=n;a.forEach(function(e){e.col>t&&(t=e.col)}),e.col=t+1}()})}function S(e){var t=0,n=[];n.push([]);var a=0;return e.forEach(function(e){e.col===t?n[a].push(e):e.col<t?n[e.col].push(e):(a++,t++,n.push([]),n[a].push(e))}),n}function z(e,t){var n=1,a=0,i=[],r=0,s=[];e.forEach(function(e){e.forEach(function(e){i=[],e.children.values().forEach(function(e,l){n=1,a=0,r=0,e.x=0,e.y=l*t.height,e.preds.empty()||(n=e.preds.size(),e.preds.values().forEach(function(e){a+=e.y+e.parent.y}),-1===i.indexOf(a/n)?(e.l.bcOrder=a/n,i.push(a/n)):(r+=.01,e.l.bcOrder=a/n+r,i.push(a/n+r)),s.push(e))}),s.sort(function(e,t){return e.l.bcOrder-t.l.bcOrder}).forEach(function(e,n){e.y=n*t.height}),s=[]})}),r=0;var l=[];e[0][0].children.values().forEach(function(e,o){e.x=0,e.y=o*t.height,a=0,n=0,e.succs.values().forEach(function(i){i.inputs.values().forEach(function(r){r.preds.values().some(function(t){return t.parent===e})&&(a+=i.parent.y+i.y+i.y/t.height/10+r.y,n++)})}),0!==n?-1===i.indexOf(a/n)?(e.l.bcOrder=a/n,i.push(a/n)):(r+=.01,e.l.bcOrder=a/n+r,i.push(a/n+r)):(e.l.bcOrder=0,l.push(e)),s.push(e)}),s.sort(function(e,t){return e.l.bcOrder-t.l.bcOrder});for(var o=0;o<l.length/2;o++)s.push(s.shift());s.forEach(function(e,n){e.y=n*t.height})}function _(e,n){e.saNodes.forEach(function(e){var i=new a.graphlib.Graph;i.setGraph({rankdir:"LR",nodesep:0,edgesep:0,ranksep:0,marginx:0,marginy:0}),i.setDefaultEdgeLabel(function(){return{}}),e.children.values().forEach(function(e){i.setNode(e.autoId,{label:e.autoId,width:n.width,height:n.height})}),e.links.values().forEach(function(e){i.setEdge(e.source.autoId,e.target.autoId,{minlen:0,weight:1,width:0,height:0,labelpos:"r",labeloffset:10})}),a.layout(i),t.entries(i._nodes).forEach(function(t){e.children.has(t.key)&&(e.children.get(t.key).x=parseInt(t.value.x-n.width/2,10),e.children.get(t.key).y=parseInt(t.value.y-n.height/2,10))})})}function j(e,n){var i=new a.graphlib.Graph;i.setGraph({rankdir:"LR",nodesep:0,edgesep:0,ranksep:0,marginx:0,marginy:0}),i.setDefaultEdgeLabel(function(){return{}}),e.aNodes.forEach(function(e){i.setNode(e.autoId,{label:e.autoId,width:n.width,height:n.height})}),e.aLinks.forEach(function(e){i.setEdge(e.source.parent.parent.autoId,e.target.parent.parent.autoId,{minlen:1,weight:1,width:0,height:0,labelpos:"r",labeloffset:10})}),a.layout(i);var r=t.entries(i._nodes);e.aNodes.forEach(function(e){e.x=parseInt(r.filter(function(t){return t.key===e.autoId.toString()})[0].value.x-n.width/2,10),e.y=parseInt(r.filter(function(t){return t.key===e.autoId.toString()})[0].value.y-n.height/2,10)})}function U(e,t){j(e,t),_(e,t);var n=[],a=[];a.push(e.dataset);var i=C(a,e.aNodes.length,e);if(null===i)throw new Error("Graph is not acyclic.");return O(i,e),a=[],a.push(e.dataset),e.aNodes.forEach(function(e){e.l.ts.removed=!1}),e.aLinks.forEach(function(e){e.l.ts.removed=!1}),i=C(a,e.aNodes.length,e),O(i,e),n=S(i),z(n,t),n}function M(e,t){return U(e,t)}function H(e){e.children.empty()||e.children.values().forEach(function(e){e.hidden=!0,t.selectAll("#nodeId-"+e.autoId).classed({selectedNode:!1,hiddenNode:!0}),e.children.empty()||H(e)})}function W(e,t){e.children.empty()||e.children.values().forEach(function(e){e.selected=t,e.doi.selectedChanged(),e.children.empty()||W(e,t)})}function P(e){return t.time.format("%Y-%m-%d %H:%M:%S %p")(e)}function F(e){return t.time.format("%Y-%m-%dT%H:%M:%S.%L").parse(e)}function G(e,t){var n=!0;return e.size()===t.size()?e.keys().forEach(function(e){t.has(e)||(n=!1)}):n=!1,n}function R(e){return e.children.values().map(function(e){return e.predLinks.size()}).reduce(function(e,t){return e+t})}function V(e){return e.children.values().map(function(e){return e.succLinks.size()}).reduce(function(e,t){return e+t})}function Y(e,n){var a=[],i=t.map(),r=0;return e.bclgNodes.forEach(function(s,l){var o=t.map();s.sort(function(e,t){return F(e.start)-F(t.start)}).forEach(function(e){var a=!1,i=null,r=t.map(),s=t.map();e.predLinks.values().forEach(function(e){r.set(e.source.autoId,e.source)}),e.succLinks.values().forEach(function(e){s.set(e.target.autoId,e.target)}),o.values().forEach(function(t){(t.wfUuid===e.wfUuid&&"weak"===n||t.wfUuid===e.wfUuid&&"strict"===n&&t.numSubanalyses===e.children.size()&&e.predLinks.size()===t.numIns&&e.succLinks.size()===t.numOuts)&&("dataset"===e.preds.values()[0].uuid&&G(r,t.preds)||"dataset"!==e.preds.values()[0].uuid)&&(a=!0,i=t)}),a?e.motif=i:!function(){var t=new d;e.predLinks.values().forEach(function(e){t.preds.set(e.source.autoId,e.source)}),e.succLinks.values().forEach(function(e){t.succs.set(e.target.autoId,e.target)}),t.numIns=e.predLinks.size(),t.numOuts=e.succLinks.size(),t.wfUuid=e.wfUuid,t.numSubanalyses=e.children.size(),o.set(t.autoId,t),e.motif=t}()}),a.push(t.map()),s.forEach(function(t){var n=t.preds.values().map(function(e){return e.motif.autoId}),s=Object.create(null);a[l].has(n+"-"+t.motif.autoId)?(s=i.get(a[l].get(n+"-"+t.motif.autoId)),s.children.set(t.autoId,t),t.layer=s):(s=new c(r,t.motif,e,!1),s.children.set(t.autoId,t),t.layer=s,i.set(s.autoId,t.layer),r++,a[l].set(n+"-"+t.motif.autoId,s.autoId))})}),i}function X(e){e.lNodes.values().forEach(function(t){t.children.values().forEach(function(e){e.parent=e.layer,e.inputs.values().forEach(function(e){t.inputs.set(e.autoId,e)}),e.outputs.values().forEach(function(e){t.outputs.set(e.autoId,e)})});var n="dataset";"undefined"!=typeof e.workflowData.get(t.motif.wfUuid)&&(n=e.workflowData.get(t.motif.wfUuid).name),t.wfName=n.toString(),t.wfCode=t.children.values()[0].wfCode,t.parent=e,t.children.size()<=1&&(t.hidden=!0),1===t.children.size()&&(t.children.values()[0].hidden=!1,t.children.values()[0].predLinks.values().forEach(function(e){e.hidden=!1}),t.children.values()[0].succLinks.values().forEach(function(e){e.hidden=!1}))}),e.lNodes.values().forEach(function(e){e.children.values().forEach(function(t){t.preds.values().forEach(function(t){e.preds.has(t.layer.autoId)||e.preds.set(t.layer.autoId,t.layer)})}),e.children.values().forEach(function(t){t.succs.values().forEach(function(t){e.succs.has(t.layer.autoId)||e.succs.set(t.layer.autoId,t.layer)})})}),e.lNodes.values().forEach(function(e){e.children.values().forEach(function(t){t.links.values().forEach(function(t){e.links.set(t.autoId,t)})})});var t=0;e.lNodes.values().forEach(function(n){n.succs.values().forEach(function(a){var i=new u(t,n,a,n.hidden||a.hidden);e.lLinks.set(i.autoId,i),n.succLinks.set(i.autoId,i),a.predLinks.set(i.autoId,i),t++})})}function $(e){e.aNodes.sort(function(e,t){return F(e.start)-F(t.start)}).forEach(function(e){1!==e.parent.children.size()&&(e.motifDiff.numSubanalyses=e.children.size()-e.motif.numSubanalyses,e.motifDiff.numIns=e.predLinks.size()-e.motif.numIns,e.motifDiff.numOuts=e.succLinks.size()-e.motif.numOuts)})}function J(e){e.aNodes.forEach(function(t){t.layer=Object.create(null),t.motif=Object.create(null),t.parent=e,t.motifDiff={numIns:0,numOuts:0,wfUuid:t.wfUuid,numSubanalyses:0}}),e.lNodes=t.map(),e.lLinks=t.map()}function q(e,t){J(e),e.lNodes=Y(e,t),X(e),$(e)}function K(e,t){return q(e,t)}function Q(e,t,n){e.html(t),e.style("visibility","visible"),e.style("top",n.pageY+10+"px"),e.style("left",n.pageX+10+"px")}function Z(e){e.style("visibility","hidden")}function ee(e){for(var t=e,n=0,a=0;t.hidden&&!(t instanceof c);)t=t.parent;if(t instanceof c)n=t.x,a=t.y;else for(;!(t instanceof c);)n+=t.x,a+=t.y,t=t.parent;return{x:n,y:a}}function te(e,n,a){var i=a;i||(i=0);var r=e.hidden?t.min(e.children.values(),function(n){return n.hidden?t.min(n.children.values(),function(t){return t.hidden?e.x:e.x+n.x+t.x}):e.x+n.x}):e.x,s=e.hidden?t.max(e.children.values(),function(n){return n.hidden?t.max(n.children.values(),function(t){return t.hidden?e.x:e.x+n.x+t.x}):e.x+n.x}):e.x,l=e.hidden?t.min(e.children.values(),function(n){return n.hidden?t.min(n.children.values(),function(t){return t.hidden?e.y:e.y+n.y+t.y}):e.y+n.y}):e.y,o=e.hidden?t.max(e.children.values(),function(n){return n.hidden?t.max(n.children.values(),function(t){return t.hidden?e.y:e.y+n.y+t.y}):e.y+n.y}):e.y;return{x:{min:r+i,max:s+n.width-i},y:{min:l+i,max:o+n.height-i}}}function ne(e){var n="";return e.forEach(function(e){n+="."+e+","}),t.selectAll(n.substr(0,n.length-1))}function ae(e){e.values().forEach(function(e){e.filtered=!0,e.doi.filteredChanged(),e.children.values().forEach(function(e){e.filtered=!0,e.doi.filteredChanged(),e.children.values().forEach(function(e){e.filtered=!0,e.doi.filteredChanged(),e.children.values().forEach(function(e){e.filtered=!0,e.doi.filteredChanged()})})})})}function ie(e,n){var a=t.time.format.iso(new Date(0)),i=t.time.format.iso(new Date(0));e.length>1&&(a=t.min(e,function(e){return F(e.start)}),i=t.max(e,function(e){return F(e.start)}));var r=t.time.scale().domain([a,i]).range([0,1]);e.forEach(function(e){e.doi.initTimeComponent(r(F(e.start))),e.children.values().forEach(function(t){t.doi.initTimeComponent(r(F(e.start))),t.children.values().forEach(function(t){t.doi.initTimeComponent(r(F(e.start)))})})}),n.graph.lNodes.values().forEach(function(e){e.doi.initTimeComponent(t.mean(e.children.values(),function(e){return r(F(e.start))}))})}function re(e,n,a){var i=void 0,r=void 0,s=void 0,l=0;return e.children.empty()||!e.hidden?(i=-n.width/2+a,s=n.width/2-a,r=-n.width/2+a,l=n.width/2-a):(i=t.min(e.children.values(),function(e){return e.x-n.width/2+a}),s=t.max(e.children.values(),function(e){return e.x+n.width/2-a}),r=t.min(e.children.values(),function(e){return e.y-n.height/2+a}),l=t.max(e.children.values(),function(e){return e.y+n.height/2-a})),{x:{min:i,max:s},y:{min:r,max:l}}}function se(e,n,i){var r=new a.graphlib.Graph;r.setGraph({rankdir:"LR",nodesep:0,edgesep:0,ranksep:0,marginx:0,marginy:0}),r.setDefaultEdgeLabel({});var s=0,l=0;e.lNodes.values().forEach(function(e){s=n.width,l=n.height,r.setNode(e.autoId,{label:e.autoId,width:s,height:l})}),e.lLinks.values().forEach(function(e){r.setEdge(e.source.autoId,e.target.autoId,{minlen:1,weight:1,width:0,height:0,labelpos:"r",labeloffset:0})}),a.layout(r);var o=t.entries(r._nodes);e.lNodes.values().forEach(function(e){s=n.width,l=n.height,e.x=o.filter(function(t){return t.key===e.autoId.toString()})[0].value.x-s/2,e.y=o.filter(function(t){return t.key===e.autoId.toString()})[0].value.y-l/2,i(e,t.select("#gNodeId-"+e.autoId))})}function le(e,n,a,i){var r=t.behavior.drag().origin(function(e){return e}).on("dragstart",n).on("drag",a).on("dragend",i);e.call(r)}function oe(e,t,n,a,i){var r=" M"+t+","+n;return r=r.concat(" L"+a+","+i)}function de(){t.event.sourceEvent.stopPropagation()}function ce(){Mt.classed("filteredLink",!1),St.each(function(e){e.filtered?e.links.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed({filteredLink:!0,blendedLink:!1})}):e.links.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("filteredLink",!1),"blend"===$t?t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("blendedLink",!0):t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("blendedLink",!1)})})}function ue(e,t,n,a){e.transition().duration(Zt?0:en).attr("transform","translate("+n+","+a+")")}function fe(){var e=this;Pt.each(function(n){var a=t.select(e).select("#nodeId-"+n.autoId);n.filtered?(a.classed("filteredNode",!0).classed("blendedNode",!1),n.hidden||t.select("#BBoxId-"+n.autoId).classed("hiddenBBox",!1)):(a.classed("filteredNode",!1).classed("blendedNode","blend"===$t),t.select("#BBoxId-"+n.autoId).classed("hiddenBBox",!0))}),Ht.each(function(n){var a=t.select(e).select("#nodeId-"+n.autoId);n.filtered?(n.children.values().forEach(function(e){t.select("#nodeId-"+e.autoId).classed("filteredNode",!0).classed("blendedNode",!1),e.children.values().forEach(function(e){e.filtered?t.select("#nodeId-"+e.autoId).classed("filteredNode",!0).classed("blendedNode",!1):t.select("#nodeId-"+e.autoId).classed("filteredNode",!1).classed("blendedNode",!1)}),(n.children.values().some(function(e){return!e.hidden})||n.children.values().some(function(e){return e.children.values().some(function(e){return!e.hidden})}))&&t.select("#BBoxId-"+n.autoId).classed("hiddenBBox",!1)}),n.hidden||t.select("#BBoxId-"+n.autoId).classed("hiddenBBox",!1),a.classed("filteredNode",!0).classed("blendedNode",!1)):(a.classed("filteredNode",!1).classed("blendedNode","blend"===$t),t.select("#BBoxId-"+n.autoId).classed("hiddenBBox",!0),n.children.values().forEach(function(e){t.select("#nodeId-"+e.autoId).classed("filteredNode",!1).classed("blendedNode","blend"===$t),e.children.values().forEach(function(e){t.select("#nodeId-"+e.autoId).classed("filteredNode",!1).classed("blendedNode","blend"===$t)})}))})}function he(e){var n=t.map(),a=t.map();switch(e.nodeType){case"layer":e.predLinks.values().forEach(function(e){n.set(e.autoId,e)}),e.succLinks.values().forEach(function(e){a.set(e.autoId,e)}),e.children.values().forEach(function(e){e.predLinks.values().forEach(function(e){n.set(e.autoId,e)}),e.succLinks.values().forEach(function(e){a.set(e.autoId,e)})});break;case"analysis":e.predLinks.values().forEach(function(e){n.set(e.autoId,e)}),e.succLinks.values().forEach(function(e){a.set(e.autoId,e)})}n.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("link-transition",!0).transition().duration(Zt?0:en).attr("d",function(e){var t=ee(e.source),n=ee(e.target);return"bezier1"===cn?ge(e,t.x,t.y,n.x,n.y):oe(e,t.x,t.y,n.x,n.y)}),setTimeout(function(){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("link-transition",!1)},en)}),a.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("link-transition",!0).transition().duration(Zt?0:en).attr("d",function(e){var t=ee(e.target),n=ee(e.source);return"bezier1"===cn?ge(e,n.x,n.y,t.x,t.y):oe(e,n.x,n.y,t.x,t.y)}),setTimeout(function(){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("link-transition",!1)},en)})}function pe(e,n,a){var i="undefined"!=typeof a?a:"user",r=Object.create(null),s=Object.create(null),l=[];"e"!==n||"layer"!==e.nodeType&&"analysis"!==e.nodeType&&"subanalysis"!==e.nodeType?"c"===n&&"layer"!==e.nodeType&&("subanalysis"===e.nodeType?e.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0)}):"analysis"===e.nodeType?(e.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0),e.exaggerated=!1}),t.select("#nodeId-"+e.parent.autoId).select("g.labels").select(".lLabel").text(e.children.size()+"/"+e.children.size()),t.select("#BBoxId-"+e.parent.autoId).classed("hiddenBBox",!1),e.parent.children.values().forEach(function(e){e.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0)})})):e.hidden===!1&&(s=re(e.parent,Tt,0),l=e.parent.parent.children.values().filter(function(t){return t!==e.parent&&t.y>e.parent.y}),l.forEach(function(e){e.y-=s.y.max-s.y.min-Tt.height,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)}),e.parent.parent.children.values().filter(function(t){return t!==e.parent}).some(function(e){return e.hidden})&&(r=te(e.parent.parent,Tt,0),e.parent.x=(r.x.max-r.x.min)/2-Dt.cell.width/2,ue(t.select("#gNodeId-"+e.parent.autoId),e.parent,e.parent.x,e.parent.y)),e.parent.parent.children.values().filter(function(t){return t!==e.parent}).every(function(e){return!e.hidden})&&e.parent.parent.children.values().forEach(function(e){e.x=0,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)})),e.parent.hidden=!1,t.select("#nodeId-"+e.parent.autoId).classed("hiddenNode",!1),H(e.parent),"subanalysis"===e.nodeType?t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0):"analysis"===e.nodeType?e.parent.filtered||t.select("#BBoxId-"+e.parent.autoId).classed("hiddenBBox",!0):t.select("#BBoxId-"+e.parent.autoId).classed("hiddenBBox",!0),e.parent.links.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("hiddenLink",!0),e.hidden=!0}),e.parent.inputs.values().forEach(function(e){e.predLinks.values().forEach(function(e){t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),e.hidden=!1})}),e.parent.outputs.values().forEach(function(e){e.succLinks.values().forEach(function(e){t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),e.hidden=!1})}),"subanalysis"===e.nodeType?(t.selectAll("#BBoxId-"+e.parent.autoId+", #aBBClipId-"+e.parent.autoId).selectAll("rect").attr("width",Tt.width).attr("height",Tt.height),he(e.parent)):"analysis"===e.nodeType?(e.parent.predLinks.values().forEach(function(e){e.source.hidden||(e.hidden=!1)}),e.parent.succLinks.values().forEach(function(e){e.target.hidden||(e.hidden=!1)}),he(e.parent),ue(t.select("#gNodeId-"+e.parent.autoId),e.parent,e.parent.x,e.parent.y)):(t.select("#BBoxId-"+e.parent.autoId).classed("hiddenBBox",!0),he(e.parent.parent),ue(t.select("#gNodeId-"+e.parent.parent.autoId),e.parent.parent,e.parent.parent.x,e.parent.parent.y),r=te(e.parent.parent,Tt,0),t.selectAll("#BBoxId-"+e.parent.parent.autoId+", #aBBClipId-"+e.parent.parent.autoId).selectAll("rect").attr("width",r.x.max-r.x.min).attr("height",r.y.max-r.y.min),e.parent.parent.children.values().some(function(e){return e.hidden})||(r=te(e.parent.parent,Tt,0),t.select("#BBoxId-"+e.parent.parent.autoId).select("rect").attr("width",r.x.max-r.x.min).attr("height",r.y.max-r.y.min),t.select("#aBBClipId-"+e.parent.parent.autoId).select("rect").attr("width",Tt.width).attr("height",Tt.height+2*on*Dt.radius).attr("rx",Tt.width/7).attr("ry",Tt.height/7)),he(e.parent.parent))):(t.select("#nodeId-"+e.autoId).classed("hiddenNode",!0),e.hidden=!0,e.children.values().forEach(function(e){t.select("#nodeId-"+e.autoId).classed("hiddenNode",!1),e.hidden=!1,H(e)}),"subanalysis"===e.nodeType?e.links.values().forEach(function(e){e.hidden=!1,t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1)}):"analysis"===e.nodeType?e.children.values().forEach(function(e){e.links.values().forEach(function(e){e.hidden=!0,t.select("#linkId-"+e.autoId).classed("hiddenLink",!0),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!0)})}):(e.predLinks.values().forEach(function(e){e.hidden=!0,t.select("#linkId-"+e.autoId).classed("hiddenLink",!0),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!0)}),e.succLinks.values().forEach(function(e){e.hidden=!0,t.select("#linkId-"+e.autoId).classed("hiddenLink",!0),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!0)})),e.inputs.values().forEach(function(e){e.predLinks.values().forEach(function(e){t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),e.hidden=!1})}),e.outputs.values().forEach(function(e){e.succLinks.values().forEach(function(e){t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),e.hidden=!1})}),"subanalysis"===e.nodeType?(t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),s=re(e,Tt,0),e.x=0,he(e.parent),ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y),l=e.parent.children.values().filter(function(t){return t!==e&&t.y>e.y}),l.forEach(function(e){e.y+=s.y.max-s.y.min-Tt.height,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)}),r=te(e.parent,Tt,0),t.selectAll("#BBoxId-"+e.parent.autoId+", #aBBClipId-"+e.parent.autoId).selectAll("rect").attr("width",r.x.max-r.x.min).attr("height",r.y.max-r.y.min),e.parent.children.values().filter(function(e){return!e.hidden}).forEach(function(e){e.x=(r.x.max-r.x.min)/2-Dt.cell.width/2,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)}),ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)):"analysis"===e.nodeType?(r=te(e,Tt,0),t.select("#BBoxId-"+e.autoId).select("rect").attr("width",r.x.max-r.x.min).attr("height",r.y.max-r.y.min),he(e),ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)):(e.children.values().filter(function(e){return e.filtered}).forEach(function(e){t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),e.links.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+",#hLinkId-"+e.autoId).classed("hiddenLink",!0)}),e.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0)}),r=te(e,Tt,0),t.selectAll("#BBoxId-"+e.autoId+", #aBBClipId-"+e.autoId).select("rect").attr("width",Tt.width).attr("height",Tt.height)}),he(e),ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y))),"user"===i&&(_e(Dt.graph),hn&&Ue(en))}function ve(){function e(e){for(var t=e;!(t instanceof c);){if(!(t instanceof c||t.parent.hidden))return!1;t=t.parent}return!0}_t.select(".nodeDoiLabel").text(function(e){return e.doi.doiWeightedSum}),Dt.graph.lNodes.values().forEach(function(e){e.doi.doiWeightedSum>=.25&&!e.hidden&&e.filtered&&pe(e,"e","auto")}),Dt.graph.aNodes.forEach(function(e){
e.doi.doiWeightedSum>=.5&&!e.hidden&&e.filtered?pe(e,"e","auto"):e.doi.doiWeightedSum<.25&&!e.hidden&&e.parent.children.size()>1&&(pe(e,"c","auto"),e.parent.filtered&&e.parent.children.values().forEach(function(n){n.doi.doiWeightedSum>=.25?(n.exaggerated=!0,n.hidden=!1,t.select("#nodeId-"+n.autoId).classed("hiddenNode",!1),he(n),n.doi.doiWeightedSum>=.5&&!n.hidden&&n.filtered&&pe(n,"e","auto")):(n.exaggerated=!1,n.hidden=!0,t.select("#nodeId-"+e.autoId).classed("hiddenNode",!0))}))}),Dt.graph.saNodes.forEach(function(n){var a=t.max(n.children.values(),function(e){return e.doi.doiWeightedSum});.75>a&&(e(n.children.values()[0])||n.parent.exaggerated)&&pe(n.children.values()[0],"c","auto")}),Dt.graph.saNodes.forEach(function(n){var a=t.max(n.parent.children.values(),function(e){return e.doi.doiWeightedSum});n.doi.doiWeightedSum>=.75&&!n.hidden&&n.filtered?pe(n,"e","auto"):.5>a&&(e(n)||n.parent.exaggerated)&&pe(n,"c","auto")}),_e(Dt.graph),hn&&Ue(en)}function ge(e,t,n,a,i){var r="M"+t+","+n;return a-t>1.5*Dt.cell.width?!function(){var s=e.source,o=t;if(e.source instanceof c||e.target instanceof c||e.source.parent!==e.target.parent){for(;!(s instanceof l||s instanceof c);)s=s.parent;s instanceof l&&!s.parent.hidden&&e.source.hidden&&(s=s.parent),o=e.source instanceof c&&e.source.hidden?t+Dt.cell.width/2:te(s,Tt,0).x.max-Dt.cell.width/2,dn.values().forEach(function(e){if(-1!==e.nodes.indexOf(s.autoId)){var n=te(s,Tt,0).x.max-te(s,Tt,0).x.min,a=(e.width-n)/2+Dt.cell.width/2;n<e.width&&(o=t+a)}}),r=r.concat(" H"+o)}r=r.concat(" C"+(o+Tt.width/3)+","+n+" "+(o+Tt.width/2-Tt.width/3)+","+i+" "+(o+Tt.width/2)+","+i+" H"+a)}():r=r.concat(" C"+(t+Tt.width)+","+n+" "+(a-Tt.width)+","+i+" "+a+","+i+" "),r}function me(e){var n=t.select(this);Z(At);var a=t.event.y-e.y;e.x=t.event.x,e.y=t.event.y,ue(n,e,t.event.x,t.event.y),he(e),e instanceof c&&e.children.values().forEach(function(n){n.x=e.x-(te(n,Tt,0).x.max-te(n,Tt,0).x.min)/2+Dt.cell.width/2,n.y+=a,ue(t.select("#gNodeId-"+n.autoId),n,n.x,n.y),he(n)}),Zt=!0}function ye(e,n){var a=n;ue(a,e,e.x,e.y),he(e),e instanceof c&&e.children.values().forEach(function(e){ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y),he(e)})}function xe(e){if(Zt){var n=t.select(this);ye(e,n),setTimeout(function(){Zt=!1},200)}}function be(e,n,a){a.graph.lNodes=ln,a.graph.aNodes=tn,a.graph.saNodes=nn,a.graph.nodes=an,a.graph.aLinks=rn,a.graph.lLinks=sn;var i=a.graph.aNodes.filter(function(t){return n.setSeconds(n.getSeconds()+1),F(t.start)>=e&&F(t.start)<=n});a.graph.aNodes.forEach(function(e){-1===i.indexOf(e)?(e.filtered=!1,e.children.values().forEach(function(e){e.filtered=!1,e.children.values().forEach(function(e){e.filtered=!1})})):(e.filtered=!0,e.children.values().forEach(function(e){e.filtered=!0,e.children.values().forEach(function(e){e.filtered=!0})}))}),a.graph.aNodes.forEach(function(e){e.children.values().some(function(e){return e.filtered})?e.filtered=!0:e.filtered=!1,e.doi.filteredChanged()}),a.graph.lNodes.values().forEach(function(e){e.children.values().some(function(e){return e.filtered})?e.filtered=!0:e.filtered=!1,e.doi.filteredChanged()}),a.graph.aLinks.forEach(function(e){e.filtered=!1}),a.graph.aLinks.filter(function(e){return e.source.parent.parent.filtered&&e.target.parent.parent.filtered}).forEach(function(e){e.filtered=!0}),a.graph.lLinks.values().forEach(function(e){e.filtered=!1}),a.graph.lLinks.values().filter(function(e){return e.source.filtered&&e.target.filtered}).forEach(function(e){e.filtered=!0}),"hide"===$t&&!function(){var e=t.map();a.graph.lNodes.entries().forEach(function(t){t.value.filtered&&e.set(t.key,t.value)}),a.graph.lNodes=e,a.graph.aNodes=a.graph.aNodes.filter(function(e){return e.filtered}),a.graph.saNodes=a.graph.saNodes.filter(function(e){return e.filtered}),a.graph.nodes=a.graph.nodes.filter(function(e){return e.filtered}),a.graph.aLinks=a.graph.aLinks.filter(function(e){return e.filtered});var n=t.map();a.graph.lLinks.entries().forEach(function(e){e.value.filtered&&n.set(e.key,e.value)}),a.graph.lLinks=n}(),_e(a.graph),hn&&Ue(en),fe(),ce(),Ne(a.graph),Te(a.graph.lLinks),a.graph.aNodes.forEach(function(e){he(e)}),a.graph.lNodes.values().forEach(function(e){he(e)}),vn&&ke()}function Ie(e){function n(){t.event.sourceEvent.stopPropagation()}function a(e){var n=Object.create(null),a=Object.create(null);return"startTimeline"===e.className?(n=e.time,a=t.select(".endTimeline").data()[0].time):(n=t.select(".startTimeline").data()[0].time,a=e.time),[n,a]}function i(e){var n=this,i=a(e);i[1].setSeconds(i[1].getSeconds()+1);var r=P(i[0]),s=P(i[1]);t.select("#tlThresholdStart").html("Start: "+r),t.select("#tlThresholdEnd").html("End: "+s),t.selectAll(".tlAnalysis").each(function(e){F(e.start)<i[0]||F(e.start)>i[1]?t.select(n).classed("blendedTLAnalysis",!0):t.select(n).classed("blendedTLAnalysis",!1)})}function r(e){t.event.x<0?e.x=0:t.event.x>f?e.x=f:e.x=t.event.x,e.time=new Date(qt.invert(e.x)),t.select(this).attr("transform","translate("+h(e.x)+",0)"),i(e),e.lastX=e.x}function s(t){t.time=new Date(qt.invert(t.x)),i(t),be(a(t)[0],a(t)[1],e),Jt="timeline"}function l(e){var a=t.behavior.drag().origin(function(e){return e}).on("dragstart",n).on("drag",r).on("dragend",s);e.call(a)}function o(){c.selectAll(".tlAnalysis").attr("x1",function(e){return h(qt(F(e.start)))}).attr("x2",function(e){return h(qt(F(e.start)))}),c.selectAll(".startTimeline, .endTimeline").attr("transform",function(e){return"translate("+h(e.x)+",0)"}),c.select("#timelineView").attr("x",h(0)).attr("width",h(f)-h(0)),c.select("#tlxAxis").attr("transform","translate("+h(0)+","+u+")"),c.select("#tlxAxis").selectAll(".tick").attr("transform",function(e){return"translate("+(h(qt(e))-t.event.translate[0])+",0)"}),c.select("#tlxAxis").select("path").attr("d","M0,6V0H"+f*t.event.scale+"V6"),c.select("#tlyAxis").attr("transform","translate("+h(0)+",10)")}var d=this,c=t.select("#provenance-timeline-view").select("svg").append("g").append("g").attr("transform","translate(20,0)"),u=50,f=250,h=t.scale.linear().domain([0,f]).range([0,f]),p=t.scale.linear().domain([5,0]).range([0,u-10]);qt=t.time.scale().domain([Date.parse(Xt.domain()[0]),Date.parse(Xt.domain()[1])]).range([0,f]).nice();var v=t.svg.axis().scale(qt).orient("bottom").ticks(5),g=t.svg.axis().scale(p).orient("left").ticks(7),m=t.map();tn.forEach(function(e){m.set(e.autoId,qt(F(e.start)))});var y=t.behavior.zoom().x(h).scaleExtent([1,10]).on("zoom",o);y(c);var x=c.append("defs").append("linearGradient").attr("id","gradientGrayscale");x.append("stop").attr("offset","0%").attr("stop-color","#fff").attr("stop-opacity",1),x.append("stop").attr("offset","100%").attr("stop-color","#000").attr("stop-opacity",1),c.append("rect").attr("id","timelineView").attr("x",0).attr("y",10).attr("width",f).attr("height",u-10).style({fill:"url(#gradientGrayscale)",stroke:"white","stroke-width":"1px"}),c.append("g").classed({x:!0,axis:!0}).attr("id","tlxAxis").attr("transform","translate(0,"+u+")").call(v),c.append("g").classed({y:!0,axis:!0}).attr("id","tlyAxis").attr("transform","translate(0,10)").call(g),t.select("#tlyAxis").selectAll(".tick").each(function(e){5===e&&t.select(d).select("text").text(">5")});var b={className:"startTimeline",x:0,lastX:-1,time:new Date(qt.invert(0))},I={className:"endTimeline",x:f,lastX:f+1,time:new Date(qt.invert(f))},k=c.selectAll(".line").data([b,I]).enter().append("g").attr("transform",function(e){return"translate("+e.x+",0)"}).attr("class",function(e){return e.className});k.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",u),k.append("polygon").classed("timeMarker",!0).attr("points","0,50 5,60 -5,60"),k.append("polygon").classed("timeMarker",!0).attr("points","0,10 5,0 -5,0"),c.selectAll(".line").data(e.graph.aNodes).enter().append("line").attr("id",function(e){return"tlAnalysisId-"+e.autoId}).classed("tlAnalysis",!0).attr("x1",function(e){return qt(F(e.start))}).attr("y1",function(e){return e.children.size()>=5?10:parseInt(u-(u-10)/5*e.children.size(),10)}).attr("x2",function(e){return qt(F(e.start))}).attr("y2",u),t.selectAll(".startTimeline, .endTimeline").on("mouseover",function(){t.select(d).classed("mouseoverTimeline",!0)}),l(t.selectAll(".startTimeline, .endTimeline")),i(b)}function ke(){Dt.graph.lNodes.values().forEach(function(e){e.doi.computeWeightedSum(),e.children.values().forEach(function(e){e.doi.computeWeightedSum(),e.children.values().forEach(function(e){e.doi.computeWeightedSum(),e.children.values().forEach(function(e){e.doi.computeWeightedSum()})})})}),ve()}function Le(){function n(t){var n=0,a=30,i=(300-t.length*a)/2,s=r.selectAll("g").data(t),o=s.attr("id",function(e,t){return"doiCompId-"+t}).classed("doiComp",!0);o.select(".doiCompRect").classed("doiCompRect",!0).attr("x",0).attr("y",function(e){return n+=300*e.value,n-300*e.value}).attr("width",40).attr("height",function(e){return 300*e.value}),o.select(".doiCompHandle").classed("doiCompHandle",!0).attr("x",40+a).attr("y",function(e,t){return i+a*t}).attr("width",a).attr("height",a).style("fill",function(e,t){return l(10-t)}),n=0,o.select(".doiCompLine",!0).attr("x1",40).attr("y1",function(e){return n+=300*e.value,n-300*e.value/2}).attr("x2",40+a).attr("y2",function(e,t){return i+a*t+a/2}).style({stroke:function(e,t){return l(10-t)},"stroke-opacity":.7,"stroke-width":"2px"});var d=s.enter().append("g").attr("id",function(e,t){return"doiCompId-"+t}).classed("doiComp",!0);d.append("rect").classed("doiCompRect",!0).attr("x",0).attr("y",function(e){return n+=300*e.value,n-300*e.value}).attr("width",40).attr("height",function(e){return 300*e.value}).style("fill",function(e,t){return l(10-t)}),n=0,d.append("rect").classed("doiCompHandle",!0).attr("x",40+a).attr("y",function(e,t){return i+a*t}).attr("width",a).attr("height",a).style("fill",function(e,t){return l(10-t)}),n=0,d.append("line").classed("doiCompLine",!0).attr("x1",40).attr("y1",function(e){return n+=300*e.value,n-300*e.value/2}).attr("x2",40+a).attr("y2",function(e,t){return i+a*t+a/2}).style({stroke:function(e,t){return l(10-t)},"stroke-opacity":.7,"stroke-width":"2px"}),s.exit().remove(),e("#doiSpinners").css("padding-top",i)}function a(){var a=t.values(ht.factors).filter(function(e){return ht.isMasked(e.label)}).length;a>0&&!function(){var n=t.values(ht.factors).filter(function(e){return ht.isMasked(e.label)}).map(function(e){return e.value}).reduce(function(e,t){return e+t}),i=1;t.values(ht.factors).forEach(function(r,s){if(ht.isMasked(r.label)){var l=e("#dc-checkbox-"+s)[0].checked;0===n?(ht.set(t.keys(ht.factors)[s],1/a,l),e("#dc-input-"+s).val(1/a)):(ht.set(t.keys(ht.factors)[s],r.value/n*i,l),e("#dc-input-"+s).val(r.value/n*i))}})}(),n(t.values(ht.factors))}var i=this,r=t.select("#provenance-doi-view").select("svg").select("g").select("g").attr("transform","translate(0,0)").select("g"),s=t.values(ht.factors),l=t.scale.category10();n(s),s.forEach(function(t,n){e("<div/>",{id:"dc-form-"+n,"class":"form dc-form",style:"height: 30px; position: absolute; left: 75px; top: "+parseInt((10-s.length)/2*30+30*(n+1)-1,10)+"px;"}).appendTo("#doiVis"),e("<input/>",{id:"dc-checkbox-"+n,"class":"dc-checkbox",type:"checkbox",checked:"true",style:"margin-top: 0px; margin-right: 2px; vertical-align: middle;"}).appendTo("#dc-form-"+n),e("<input/>",{id:"dc-input-"+n,type:"text","class":"form-control dc-input",value:t.value,style:"display: inline; width: 27px; height: 30px; margin-bottom: 0px;margin-right: 2px; text-align: left; padding: 0; margin-left: 2px; border-radius: 0px;"}).appendTo("#dc-form-"+n),e("<div/>",{id:"btn-group-wrapper-"+n,"class":"btn-group",style:"height: 32px"}).appendTo("#dc-form-"+n),e("<div/>",{id:"dc-btn-group-"+n,"class":"input-group-btn-vertical",style:"margin-right: 2px;"}).appendTo("#btn-group-wrapper-"+n),e("<button/>",{id:"dc-carret-up-"+n,"class":"refinery-base btn btn-default",html:"<i class='fa fa-caret-up'></i>"}).appendTo("#dc-btn-group-"+n),e("<button/>",{id:"dc-carret-down-"+n,"class":"refinery-base btn btn-default",html:"<i class='fa fa-caret-down'></i>"}).appendTo("#dc-btn-group-"+n),e("<span/>",{id:"dc-label-"+n,"class":"label dc-label",html:t.label,style:"margin-left: 2px; opacity: 0.7; background-color: "+l(10-n)+";"}).appendTo("#dc-form-"+n)}),e("<a/>",{id:"prov-doi-view-reset",href:"#",html:"Redistribute",style:"width: 25px; position: absolute; left: 90px; top: "+parseInt((10-s.length)/2*30+30*(s.length+1)+10,10)+"px;"}).appendTo("#doiVis"),t.selectAll(".doiComp").on("click",function(){var n=t.select(i).attr("id").substr(t.select(i).attr("id").length-1,1),r=0;e("#dc-checkbox-"+n)[0].checked?(e("#dc-checkbox-"+n).prop("checked",!1),e("#dc-label-"+n).css("opacity",.3),t.select("#doiCompId-"+n).select(".doiCompHandle").classed("blendedDoiComp",!0),t.select("#doiCompId-"+n).select(".doiCompLine").style("display","none"),e("#dc-input-"+n).val(r),ht.set(t.keys(ht.factors)[n],r,!1)):(e(e("#dc-checkbox-"+n)).prop("checked",!0),e("#dc-label-"+n).css("opacity",.7),t.select("#doiCompId-"+n).select(".doiCompHandle").classed("blendedDoiComp",!1),t.select("#doiCompId-"+n).select(".doiCompLine").style("display","inline"),ht.set(t.keys(ht.factors)[n],r,!0)),a()}),e(".dc-checkbox").click(function(){var n=e(this)[0].id[e(this)[0].id.length-1],i=0;e(this)[0].checked?(e(this.parentNode).find(".dc-label").css("opacity",.7),t.select("#doiCompId-"+n).select(".doiCompHandle").classed("blendedDoiComp",!1),t.select("#doiCompId-"+n).select(".doiCompLine").style("display","inline"),i=0,ht.set(t.keys(ht.factors)[n],i,!0)):(e(this.parentNode).find(".dc-label").css("opacity",.3),t.select("#doiCompId-"+n).select(".doiCompHandle").classed("blendedDoiComp",!0),t.select("#doiCompId-"+n).select(".doiCompLine").style("display","none"),i=0,e("#dc-input-"+n).val(i),ht.set(t.keys(ht.factors)[n],i,!1)),a()}),e(".dc-form .btn:first-of-type").on("click",function(){var a=e(i)[0].id[e(i)[0].id.length-1],r=parseFloat(e("#dc-input-"+a).val())+.01;e("#dc-checkbox-"+a)[0].checked&&1>=r&&!function(){e("#dc-input-"+a).val(r),ht.set(t.keys(ht.factors)[a],r,!0);var i=t.values(ht.factors).filter(function(e,t){return t!==a&&ht.isMasked(e.label)}).map(function(e){return e.value}).reduce(function(e,t){return e+t}),s=parseFloat(1-r);t.values(ht.factors).forEach(function(n,r){if(r!==a&&ht.isMasked(n.label)){var l=e("#dc-checkbox-"+r)[0].checked;ht.set(t.keys(ht.factors)[r],n.value/i*s,l),e("#dc-input-"+r).val(n.value/i*s)}}),n(t.values(ht.factors))}()}),e(".dc-form .btn:last-of-type").on("click",function(){var a=e(i)[0].id[e(i)[0].id.length-1],r=parseFloat(e("#dc-input-"+a).val())-.01;e("#dc-checkbox-"+a)[0].checked&&r>=0&&!function(){e("#dc-input-"+a).val(r),ht.set(t.keys(ht.factors)[a],r,!0);var i=t.values(ht.factors).filter(function(e,t){return t!==a&&ht.isMasked(e.label)}).map(function(e){return e.value}).reduce(function(e,t){return e+t}),s=parseFloat(1-r);t.values(ht.factors).forEach(function(n,r){if(r!==a&&ht.isMasked(n.label)){var l=e("#dc-checkbox-"+r)[0].checked;ht.set(t.keys(ht.factors)[r],n.value/i*s,l),e("#dc-input-"+r).val(n.value/i*s)}}),n(t.values(ht.factors))}()}),e(".dc-input").keypress(function(a){var i=this;13===a.which&&!function(){var a=e(i)[0].id[e(i)[0].id.length-1],r=parseFloat(e("#dc-input-"+a).val());r>1?r=1:0>r&&(r=0),e(i).val(r),e(e("#dc-checkbox-"+a)).prop("checked",!0),e("#doiCompId-"+a).find(".dc-label").css("opacity",.7),t.select("#doiCompId-"+a).select(".doiCompHandle").classed("blendedDoiComp",!1),t.select("#doiCompId-"+a).select(".doiCompLine").style("display","inline"),ht.set(t.keys(ht.factors)[a],r,!0);var s=t.values(ht.factors).filter(function(e,t){return t!==a&&ht.isMasked(e.label)}).map(function(e){return e.value}).reduce(function(e,t){return e+t}),l=parseFloat(1-r);t.values(ht.factors).forEach(function(n,i){if(i!==a&&ht.isMasked(n.label)){var r=e("#dc-checkbox-"+i)[0].checked;ht.set(t.keys(ht.factors)[i],n.value/s*l,r),e("#dc-input-"+i).val(n.value/s*l)}}),n(t.values(ht.factors))}()}),e("#prov-doi-view-apply").on("click",function(){ke()}),e("#prov-doi-view-reset").on("click",function(){var a=parseFloat(1/t.values(ht.factors).filter(function(e){return ht.isMasked(e.label)}).length);t.values(ht.factors).forEach(function(n,i){ht.isMasked(n.label)?(e("#dc-input-"+i).val(a),ht.set(t.keys(ht.factors)[i],a,!0)):(e("#dc-input-"+i).val(0),ht.set(t.keys(ht.factors)[i],0,!1))}),n(t.values(ht.factors))}),e("#prov-doi-trigger").click(function(){vn=!!e(this).find("input[type='checkbox']").prop("checked")}),e("#prov-doi-view-show").click(function(){e(this).find("input[type='checkbox']").prop("checked")?t.selectAll(".nodeDoiLabel").style("display","inline"):t.selectAll(".nodeDoiLabel").style("display","none")})}function we(){Ft.classed("hiddenLink",!0),jt.each(function(e){e.highlighted=!1}),_t.each(function(e){e.highlighted=!1,e.doi.highlightedChanged()})}function Be(e){e.highlighted=!0,e.doi.highlightedChanged();for(var n=e.parent;n instanceof r==!0;)n.highlighted=!0,n.doi.highlightedChanged(),n=n.parent;e instanceof c?e.children.values().forEach(function(e){e.predLinks.values().forEach(function(e){e.highlighted=!0,e.hidden=!1,t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),Be(e.source)})}):e.predLinks.values().forEach(function(e){e.highlighted=!0,e.hidden||t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),Be(e.source)})}function Ee(e){e.highlighted=!0,e.doi.highlightedChanged();for(var n=e.parent;n instanceof r==!0;)n.highlighted=!0,n.doi.highlightedChanged(),n=n.parent;e instanceof c?e.children.values().forEach(function(e){e.succLinks.values().forEach(function(e){e.highlighted=!0,e.hidden=!1,t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),Ee(e.target)})}):e.succLinks.values().forEach(function(e){e.highlighted=!0,e.hidden||t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1),Ee(e.target)})}function Ne(e){var n=Dt.canvas.select("g.aHLinks").selectAll(".hLink").data(e.aLinks);n.enter().append("path").classed({hLink:!0}).classed("blendedLink","blend"===$t).classed("filteredLink",function(e){return e.filtered}).classed("hiddenLink",function(e){return!e.highlighted}).attr("id",function(e){return"hLinkId-"+e.autoId}),n.attr("d",function(e){var t=ee(e.source),n=ee(e.target);return"bezier1"===cn?ge(e,t.x,t.y,n.x,n.y):oe(e,t.x,t.y,n.x,n.y)}).classed("blendedLink",function(e){return!e.filtered&&"blend"===$t}).classed("filteredLink",function(e){return e.filtered}).classed("hiddenLink",function(e){return!e.highlighted}).attr("id",function(e){return"hLinkId-"+e.autoId}),n.exit().remove(),Ft=t.selectAll(".hLink");var a=Dt.canvas.select("g.aLinks").selectAll(".link").data(e.aLinks);a.enter().append("path").classed({link:!0,aLink:!0}).classed("blendedLink",function(e){return!e.filtered&&"blend"===$t}).classed("filteredLink",function(e){return e.filtered}).classed("hiddenLink",function(e){return e.hidden}).attr("id",function(e){return"linkId-"+e.autoId}),a.attr("d",function(e){var t=ee(e.source),n=ee(e.target);return"bezier1"===cn?ge(e,t.x,t.y,n.x,n.y):oe(e,t.x,t.y,n.x,n.y)}).classed("blendedLink",function(e){return!e.filtered&&"blend"===$t}).classed("filteredLink",function(e){return e.filtered}).classed("hiddenLink",function(e){return e.hidden}).attr("id",function(e){return"linkId-"+e.autoId}),a.exit().remove(),Ut=t.selectAll(".aLink"),jt=t.selectAll(".link")}function Ae(e,n){var a=t.min(e,function(e){return F(e.start)}),i=t.max(e,function(e){return F(e.start)});return t.time.scale().domain([a,i]).range([n[0],n[1]])}function De(e){var n=this,a=Dt.canvas.select("g.layers").selectAll(".layer").data(e.values()),i=a.enter().append("g").classed({layer:!0});i.attr("id",function(e){return"gNodeId-"+e.autoId}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"});var r=i.append("defs").append("linearGradient").attr("id",function(e){return"layerGradientId-"+e.autoId}).attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%");r.append("stop").attr("offset","0%").attr("stop-color",function(e){var n=t.min(e.children.values(),function(e){return e.start});return Xt(F(n))}).attr("stop-opacity",1),r.append("stop").attr("offset","100%").attr("stop-color",function(e){var n=t.max(e.children.values(),function(e){return e.start});return Xt(F(n))}).attr("stop-opacity",1),Yt=i.append("g").attr("id",function(e){return"BBoxId-"+e.autoId}).classed({lBBox:!0,BBox:!0,hiddenBBox:!1}).attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")"),Yt.append("rect").attr("y",-.6*on*Dt.radius).attr("width",Tt.width).attr("height",Tt.height).attr("rx",Tt.width/7).attr("ry",Tt.height/7),Yt.append("defs").append("clipPath").attr("id",function(e){return"lBBClipId-"+e.autoId}).append("rect").attr("y",-.6*on*Dt.radius).attr("width",Tt.width).attr("height",Tt.height+2*on*Dt.radius).attr("rx",Tt.width/7).attr("ry",Tt.height/7),Yt.append("g").classed("labels",!0).attr("clip-path",function(e){return"url(#lBBClipId-"+e.autoId+")"}).append("text").attr("transform","translate("+1*on*Dt.radius+","+.5*on*Dt.radius+")").text(function(e){return" "+e.wfCode}).classed("lBBoxLabel",!0).style("font-family","FontAwesome");var s=Yt.append("g").classed("lDiff",!0).attr("transform","translate(0,0)");s.each(function(e){e.children.values().some(function(e){return 0!==e.motifDiff.numIns||0!==e.motifDiff.numOuts||0!==e.motifDiff.numSubanalyses})&&t.select(n).append("text").text("").classed("diff-node-type-icon",!0).style("font-family","FontAwesome")});var l=i.append("g").attr("id",function(e){return"nodeId-"+e.autoId}).classed({lNode:!0,filteredNode:!0,blendedNode:!1,selectedNode:!1,hiddenNode:function(e){return e.hidden}});i.append("g").classed({children:!0});var o=l.append("g").classed({glyph:!0}),d=l.append("g").classed({labels:!0});o.append("defs").append("clipPath").attr("id",function(e){return"bbClipId-"+e.autoId}).append("rect").attr("x",-2*on*Dt.radius).attr("y",-2*on*Dt.radius).attr("rx",1).attr("ry",1).attr("width",4*on*Dt.radius).attr("height",4*on*Dt.radius),o.each(function(e){R(e)>0&&t.select(n).append("g").classed("glAnchor",!0).append("path").attr("d","m"+-2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+-.8*on*Dt.radius+" a"+-.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 0 0 "+1*on*Dt.radius+" h"+.8*on*Dt.radius+" z").classed("llAnchor",!0)}),o.each(function(e){V(e)>0&&t.select(n).append("g").classed("grAnchor",!0).append("path").attr("d","m"+2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+.8*on*Dt.radius+" a"+.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 1 0 "+1*on*Dt.radius+" h"+-.8*on*Dt.radius+" z").classed("rlAnchor",!0)}),o.each(function(e){R(e)>1&&t.select(n).select("g.glAnchor").append("text").attr("transform","translate("+-2.8*on*Dt.radius+",0.5)").text(R(a)).attr("class","lLabel")}),o.each(function(e){V(e)>1&&t.select(n).select("g.grAnchor").append("text").attr("transform","translate("+2.8*on*Dt.radius+",0.5)").text(V(a)).attr("class","lLabel")}),o.append("rect").attr("x",-2.25*on*Dt.radius).attr("y",-1*on*Dt.radius).attr("rx",1).attr("ry",1).attr("width",4.5*on*Dt.radius).attr("height",2*on*Dt.radius).style("fill",function(e){return"url(#layerGradientId-"+e.autoId+")"}).classed("lGlyph",!0),d.append("text").text(function(e){return e.doi.doiWeightedSum}).attr("class","nodeDoiLabel").style("display","none"),d.append("g").classed("wfLabel",!0).attr("clip-path",function(e){return"url(#bbClipId-"+e.autoId+")"}),d.append("text").attr("transform","translate("+-1.1*on*Dt.radius+","+0*on*Dt.radius+")").text("").classed("l-node-type-icon",!0).style("fill",function(e){var n=t.min(e.children.values(),function(e){return e.start});return Xt(F(n))<"#888888"?"#ffffff":"#000000"}),d.append("text").attr("transform","translate("+.8*on*Dt.radius+",0.25)").text(function(e){return e.children.size()}).attr("class","lnLabel glyphNumeral").style("fill",function(e){var n=t.min(e.children.values(),function(e){return e.start});return Xt(F(n))<"#888888"?"#ffffff":"#000000"}),a.attr("id",function(e){return"gNodeId-"+e.autoId}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),a.exit().remove(),Pt=Dt.canvas.select("g.layers").selectAll(".layer"),Ct=t.selectAll(".lNode"),Yt=t.selectAll(".lBBox")}function Te(e){var t=Dt.canvas.select("g.lLinks").selectAll(".link").data(e.values());t.enter().append("path").classed({link:!0,lLink:!0}).attr("id",function(e){return"linkId-"+e.autoId}).classed("blendedLink",function(e){return!e.filtered&&"blend"===$t}).classed("filteredLink",function(e){return e.filtered}).classed("hiddenLink",function(e){return e.hidden}).attr("id",function(e){return"linkId-"+e.autoId}),t.attr("d",function(e){var t=ee(e.source),n=ee(e.target);return"bezier1"===cn?ge(e,t.x,t.y,n.x,n.y):oe(e,t.x,t.y,n.x,n.y)}).classed({link:!0,lLink:!0}).attr("id",function(e){return"linkId-"+e.autoId}).classed("blendedLink",function(e){return!e.filtered&&"blend"===$t}).classed("filteredLink",function(e){return e.filtered}).classed("hiddenLink",function(e){return e.hidden}).attr("id",function(e){return"linkId-"+e.autoId}),t.exit().remove(),Gt=Dt.canvas.select("g.lLinks").selectAll(".link")}function Ce(){var e=this,n=t.select("g.analyses").selectAll(".analysis").data(Dt.graph.aNodes.sort(function(e,t){return F(e.start)-F(t.start)})),a=n.attr("id",function(e){return"gNodeId-"+e.autoId});a.attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).style("fill",function(e){return Xt(F(e.start))}),a.select("defs").select("clipPath").attr("id",function(e){return"bbClipId-"+e.autoId}).select("rect").attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")").attr("y",-on*Dt.radius).attr("width",Tt.width).attr("height",Tt.height).attr("rx",Tt.width/7).attr("ry",Tt.height/7);var i=a.select("g").attr("id",function(e){return"BBoxId-"+e.autoId}).classed({aBBox:!0,BBox:!0,hiddenBBox:!0}).attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")");i.select("rect").attr("y",-.6*on*Dt.radius).attr("width",function(){return Tt.width}).attr("height",function(){return Tt.height}).attr("rx",Tt.width/7).attr("ry",Tt.height/7),i.select("defs").select("clipPath").attr("id",function(e){return"aBBClipId-"+e.autoId}).select("rect").attr("y",-on*Dt.radius).attr("width",Tt.width).attr("height",Tt.height).attr("rx",Tt.width/7).attr("ry",Tt.height/7),i.select("g").classed("labels",!0).attr("clip-path",function(e){return"url(#aBBClipId-"+e.autoId+")"}).select("text").attr("transform","translate("+1*on*Dt.radius+","+0*on*Dt.radius+")").text(function(e){return" "+e.wfCode}).classed("aBBoxLabel",!0).style("font-family","FontAwesome"),l=a.select("g").attr("id",function(e){return"nodeId-"+e.autoId}).classed({aNode:!0,filteredNode:!0,blendedNode:!1,selectedNode:!1}).classed("hiddenNode",function(e){return e.hidden}),a.select("g").classed("children",!0),o=l.select("g.glyph"),d=l.select("g.labels").attr("clip-path",function(e){return"url(#bbClipId-"+e.autoId+")"}),on=.75,o.each(function(n){n.predLinks.size()>0&&t.select(e).select("g.glAnchor").select("path").attr("d","m"+-2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+-.8*on*Dt.radius+" a"+-.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 0 0 "+1*on*Dt.radius+" h"+.8*on*Dt.radius+" z")}),o.each(function(e){e.predLinks.size()>1&&o.select("g.grAnchor").select("text").attr("transform","translate("+-2.8*on*Dt.radius+",0.5)").text(function(e){return e.predLinks.size()}).attr("class","aLabel").style("display","inline")}),o.each(function(n){n.succLinks.size()>0&&t.select(e).select("path").attr("d","m"+2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+.8*on*Dt.radius+" a"+.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 1 0 "+1*on*Dt.radius+" h"+-.8*on*Dt.radius+" z")}),o.each(function(n){n.succLinks.size()>1&&t.select(e).select("text").attr("transform","translate("+2.8*on*Dt.radius+",0.5)").text(function(e){return e.succLinks.size()}).attr("class","aLabel").style("display","inline")}),o.select("rect").attr("x",-2*on*Dt.radius).attr("y",-1.5*on*Dt.radius).attr("rx",1).attr("ry",1).attr("width",4*on*Dt.radius).attr("height",3*on*Dt.radius),d.select("text").text(function(e){return e.doi.doiWeightedSum}).attr("class","nodeDoiLabel").style("display","none");var r=n.enter().append("g").classed("analysis",!0).attr("id",function(e){return"gNodeId-"+e.autoId});r.attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).style("fill",function(e){return Xt(F(e.start))}),r.append("defs").append("clipPath").attr("id",function(e){return"bbClipId-"+e.autoId}).append("rect").attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")").attr("y",-on*Dt.radius).attr("width",Tt.width).attr("height",Tt.height+2*on*Dt.radius).attr("rx",Tt.width/7).attr("ry",Tt.height/7),i=r.append("g").attr("id",function(e){return"BBoxId-"+e.autoId}).classed({aBBox:!0,BBox:!0,hiddenBBox:!0}).attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")"),i.append("rect").attr("y",-.6*on*Dt.radius).attr("width",function(){return Tt.width}).attr("height",function(){return Tt.height}).attr("rx",Tt.width/7).attr("ry",Tt.height/7);var s=i.append("g").classed("aDiff",!0).attr("transform","translate(0,0)");s.each(function(n){0===n.motifDiff.numIns&&0===n.motifDiff.numOuts&&0===n.motifDiff.numSubanalyses||t.select(e).append("text").text("").classed("diff-node-type-icon",!0).style("font-family","FontAwesome")}),i.append("defs").append("clipPath").attr("id",function(e){return"aBBClipId-"+e.autoId}).append("rect").attr("y",-on*Dt.radius).attr("width",Tt.width).attr("height",Tt.height).attr("rx",Tt.width/7).attr("ry",Tt.height/7),i.append("g").classed("labels",!0).attr("clip-path",function(e){return"url(#aBBClipId-"+e.autoId+")"}).append("text").attr("transform","translate("+1*on*Dt.radius+","+0*on*Dt.radius+")").text(function(e){return" "+e.wfCode}).classed("aBBoxLabel",!0).style("font-family","FontAwesome");var l=r.append("g").attr("id",function(e){return"nodeId-"+e.autoId}).classed({aNode:!0,filteredNode:!0,blendedNode:!1,selectedNode:!1}).classed("hiddenNode",function(e){return e.hidden});r.append("g").classed("children",!0);var o=l.append("g").classed("glyph",!0),d=l.append("g").classed("labels",!0).attr("clip-path",function(e){return"url(#bbClipId-"+e.autoId+")"});o.each(function(n){n.predLinks.size()>0&&t.select(e).append("g").classed("glAnchor",!0).append("path").attr("d","m"+-2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+-.8*on*Dt.radius+" a"+-.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 0 0 "+1*on*Dt.radius+" h"+.8*on*Dt.radius+" z").classed("laAnchor",!0)}),o.each(function(n){n.predLinks.size()>1&&t.select(e).select("g.glAnchor").append("text").attr("transform","translate("+-2.8*on*Dt.radius+",0.5)").text(function(e){return e.predLinks.size()}).attr("class","aLabel").style("display","inline")}),o.each(function(n){n.succLinks.size()>0&&t.select(e).append("g").classed("grAnchor",!0).append("path").attr("d","m"+2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+.8*on*Dt.radius+" a"+.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 1 0 "+1*on*Dt.radius+" h"+-.8*on*Dt.radius+" z").classed("raAnchor",!0)}),o.each(function(n){n.succLinks.size()>1&&t.select(e).select("g.grAnchor").append("text").attr("transform","translate("+2.8*on*Dt.radius+",0.5)").text(function(e){return e.succLinks.size()}).attr("class","aLabel").style("display","inline")}),o.append("rect").attr("x",-2.25*on*Dt.radius).attr("y",-1*on*Dt.radius).attr("rx",1).attr("ry",1).attr("width",4.5*on*Dt.radius).attr("height",2*on*Dt.radius).classed("aGlyph",!0),d.append("text").text(function(e){return e.doi.doiWeightedSum}).attr("class","nodeDoiLabel").style("display","none"),d.append("text").attr("transform","translate("+-1.1*on*Dt.radius+",0)").text("").classed("an-node-type-icon",!0).style("fill",function(e){return Xt(F(e.start))<"#888888"?"#ffffff":"#000000"}),d.append("text").attr("transform","translate("+1*on*Dt.radius+",0.25)").text(function(e){return e.children.size()}).attr("class","anLabel glyphNumeral").style("fill",function(e){return Xt(F(e.start))<"#888888"?"#ffffff":"#000000"}),n.exit().remove(),Ht=Dt.canvas.select("g.analyses").selectAll(".analysis"),Ot=t.selectAll(".aNode"),Vt=t.selectAll(".aBBox")}function Oe(e){var n=t.select("#gNodeId-"+e.autoId).select("g.saHLinks").selectAll(".hLink").data(e.links.values());
n.attr("d",function(e){return"bezier1"===cn?ge(e,e.source.x,e.source.y,e.target.x,e.target.y):oe(e,e.source.x,e.source.y,e.target.x,e.target.y)}).classed({hLink:!0,hiddenLink:!0}).attr("id",function(e){return"hLinkId-"+e.autoId}),n.enter().append("path").attr("d",function(e){return"bezier1"===cn?ge(e,e.source.x,e.source.y,e.target.x,e.target.y):oe(e,e.source.x,e.source.y,e.target.x,e.target.y)}).classed({hLink:!0,hiddenLink:!0}).attr("id",function(e){return"hLinkId-"+e.autoId}),n.exit().remove();var a=t.select("#gNodeId-"+e.autoId).select("g.saLinks").selectAll(".Link").data(e.links.values());a.attr("d",function(e){return"bezier1"===cn?ge(e,e.source.x,e.source.y,e.target.x,e.target.y):oe(e,e.source.x,e.source.y,e.target.x,e.target.y)}).classed({link:!0,saLink:!0,hiddenLink:!0}).attr("id",function(e){return"linkId-"+e.autoId}),a.enter().append("path").attr("d",function(e){return"bezier1"===cn?ge(e,e.source.x,e.source.y,e.target.x,e.target.y):oe(e,e.source.x,e.source.y,e.target.x,e.target.y)}).classed({link:!0,saLink:!0,hiddenLink:!0}).attr("id",function(e){return"linkId-"+e.autoId}),a.exit().remove()}function Se(){var e=this;Ht.each(function(n){Wt=t.select(e).select(".children").selectAll(".subanalysis").data(n.children.values());var a=Wt.enter().append("g").classed("subanalysis",!0).attr("id",function(e){return"gNodeId-"+e.autoId}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"});a.each(function(n){var a=t.select(e);t.select("#gNodeId-"+n.autoId).append("g").classed("saHLinks",!0),t.select("#gNodeId-"+n.autoId).append("g").classed("saLinks",!0),Oe(n);var i=re(n,Tt,0);a.append("defs").append("clipPath").attr("id","bbClipId-"+n.autoId).append("rect").attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")").attr("width",Tt.width).attr("height",Tt.height);var r=a.append("g").attr("id","BBoxId-"+n.autoId).classed({saBBox:!0,BBox:!0,hiddenBBox:!0}).attr("transform","translate("+-Tt.width/2+","+-Tt.height/2+")");r.append("defs").attr("x",on*Dt.radius).attr("y",-.5*on*Dt.radius).append("clipPath").attr("id","saBBClipId-"+n.autoId).append("rect").attr("width",i.x.max-i.x.min-on*Dt.radius).attr("height",Tt.height),r.append("rect").attr("x",on*Dt.radius).attr("y",on*Dt.radius).attr("width",i.x.max-i.x.min-2*on*Dt.radius).attr("height",i.y.max-i.y.min-2*on*Dt.radius).attr("rx",Tt.width/7).attr("ry",Tt.height/7);var s=a.append("g").attr("id","nodeId-"+n.autoId).classed({saNode:!0,filteredNode:!0,blendedNode:!1,selectedNode:!1}).classed("hiddenNode",function(e){return e.hidden});a.append("g").classed("children",!0);var l=s.append("g").classed("glyph",!0),o=s.append("g").classed("labels",!0).attr("clip-path","url(#bbClipId-"+n.autoId+")");l.each(function(n){n.predLinks.size()>0&&t.select(e).append("g").classed("glAnchor",!0).append("path").attr("d","m"+-2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+-.8*on*Dt.radius+" a"+-.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 0 0 "+1*on*Dt.radius+" h"+.8*on*Dt.radius+" z").classed("lsaAnchor",!0)}),l.each(function(n){n.predLinks.size()>1&&t.select(e).select("g.glAnchor").append("text").attr("transform","translate("+-2.8*on*Dt.radius+",0.5)").text(function(e){return e.predLinks.size()}).attr("class","saLabel").style("display","inline")}),l.each(function(e){e.succLinks.size()>0&&l.append("g").classed("grAnchor",!0).append("path").attr("d","m"+2*on*Dt.radius+" "+-.5*on*Dt.radius+" h"+.8*on*Dt.radius+" a"+.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 1 0 "+1*on*Dt.radius+" h"+-.8*on*Dt.radius+" z").classed("rsaAnchor",!0)}),l.each(function(n){n.succLinks.size()>1&&t.select(e).select("g.grAnchor").append("text").attr("transform","translate("+2.8*on*Dt.radius+",0.5)").text(function(e){return e.succLinks.size()}).attr("class","saLabel").style("display","inline")}),l.append("rect").attr("x",-2.25*on*Dt.radius).attr("y",-1*on*Dt.radius).attr("rx",1).attr("ry",1).attr("width",4.5*on*Dt.radius).attr("height",2*on*Dt.radius),o.append("text").text(function(e){return e.doi.doiWeightedSum}).attr("class","nodeDoiLabel").style("display","none"),o.append("text").attr("transform","translate("+-1.1*on*Dt.radius+",0)").text("").classed("san-node-type-icon",!0).style("fill",function(e){return Xt(F(e.parent.start))<"#888888"?"#ffffff":"#000000"}),o.append("text").attr("transform","translate("+1*on*Dt.radius+",0.25)").text(function(e){return"dataset"!==e.wfUuid?e.children.values().filter(function(e){return"dt"===e.nodeType}).length:e.children.size()}).attr("class","sanLabel glyphNumeral").style("fill",function(e){return Xt(F(e.parent.start))<"#888888"?"#ffffff":"#000000"})})}),St=t.selectAll(".saNode"),Wt=t.selectAll(".subanalysis"),Rt=t.selectAll(".saBBox"),Mt=t.selectAll(".saLink"),jt=t.selectAll(".link"),Ft=t.selectAll(".hLink")}function ze(){var e=this;Wt.each(function(n){zt=t.select(e).select(".children").selectAll(".node").data(n.children.values()).enter().append("g").classed("node",!0).attr("id",function(e){return"gNodeId-"+e.autoId}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),zt.each(function(n){var a=t.select(e);a.attr("class",function(e){return"node "+e.nodeType+"Node"}).attr("id",function(e){return"nodeId-"+e.autoId}).classed("blendedNode",function(e){return!e.filtered&&"blend"===$t}).classed("filteredNode",function(e){return e.filtered}).classed("hiddenNode",function(e){return e.hidden}),a.append("defs").append("clipPath").attr("id","bbClipId-"+n.autoId).append("rect").attr("transform","translate("+-1.5*on*Dt.radius+","+3*-Tt.height/4+")").attr("width",Tt.width-2*on*Dt.radius).attr("height",Tt.height+1*on*Dt.radius);var i=a.append("g").classed("glyph",!0),r=a.append("g").classed("labels",!0).attr("clip-path","url(#bbClipId-"+n.autoId+")");i.each(function(n){n.predLinks.size()>0&&t.select(e).append("g").classed("glAnchor",!0).append("path").attr("d","m0 "+-.5*on*Dt.radius+" h"+-1*on*Dt.radius+" a"+-.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 0 0 "+1*on*Dt.radius+" h"+1*on*Dt.radius+" z").classed("lnAnchor",!0)}),i.each(function(e){e.succLinks.size()>0&&i.append("g").classed("grAnchor",!0).append("path").attr("d","m0 "+-.5*on*Dt.radius+" h"+1*on*Dt.radius+" a"+.5*on*Dt.radius+" "+.5*on*Dt.radius+" 0 0 1 0 "+1*on*Dt.radius+" h"+-1*on*Dt.radius+" z").classed("rnAnchor",!0)}),"raw"===n.nodeType||"intermediate"===n.nodeType||"stored"===n.nodeType?i.append("circle").attr("r",function(e){return"intermediate"===e.nodeType?3*on*Dt.radius/4:5*on*Dt.radius/6}):"special"===n.nodeType?i.append("rect").attr("transform","translate("+-3*on*Dt.radius/4+","+-3*on*Dt.radius/4+")").attr("width",1.5*on*Dt.radius).attr("height",1.5*on*Dt.radius):"dt"===n.nodeType&&i.append("rect").attr("transform","translate("+-1.25*on*Dt.radius/2+","+-1.25*on*Dt.radius/2+")rotate(45 "+1.25*on*Dt.radius/2+","+1.25*on*Dt.radius/2+")").attr("width",1.25*on*Dt.radius).attr("height",1.25*on*Dt.radius),r.append("text").text(function(e){return e.doi.doiWeightedSum}).attr("class","nodeDoiLabel").style("display","none"),r.each(function(){t.select(e).append("text").attr("transform","translate("+-1.5*on*Dt.radius+","+-1.5*on*Dt.radius+")").text(function(e){var t="";if("stored"===e.nodeType)t=e.attributes.get("name");else if("dt"===e.nodeType){if(e.name.indexOf(": ")>0){var n=e.name.substr(e.name.indexOf(": ")+2,e.name.length-e.name.indexOf(": ")-2);e.label=n;var a=e.name.substr(0,e.name.indexOf(": "));e.name=n+" ("+a+")",t=e.label}}else t=e.name;return t}).attr("class","nodeAttrLabel")}),r.each(function(n){"stored"===n.nodeType&&t.select(e).append("text").text("").classed("stored-node-type-icon",!0).style("fill",function(e){return Xt(F(e.parent.parent.start))<"#888888"?"#ffffff":"#000000"})})})}),zt=t.selectAll(".node")}function _e(e){var n=new a.graphlib.Graph;n.setGraph({rankdir:"LR",nodesep:1*on*Dt.radius,edgesep:0,ranksep:4*on*Dt.radius,marginx:0,marginy:0}),n.setDefaultEdgeLabel({});var i={},r=0,s=0,l=0,o=0;e.lNodes.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0),e.hidden?e.children.values().filter(function(e){return e.filtered||"blend"===$t}).forEach(function(e){i=te(e,Tt,0),r=i.x.max-i.x.min,s=i.y.max-i.y.min,n.setNode(e.autoId,{label:e.autoId,width:r,height:s})}):!function(){e.filtered&&t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),r=Dt.cell.width,s=Dt.cell.height,l=0,o=e.y+Dt.cell.height,e.children.values().filter(function(e){return e.filtered||"blend"===$t}).sort(function(e,t){return e.y-t.y}).forEach(function(n){n.exaggerated&&n.filtered?(l++,n.x=n.parent.x,n.y=o,o+=te(n,Tt,0).y.max-te(n,Tt,0).y.min,ye(n,t.select("#gNodeId-"+n.autoId)),t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),t.select("#BBoxId-"+n.autoId).classed("hiddenBBox",!1)):(n.x=n.parent.x,n.y=n.parent.y)});var a=e.children.values().filter(function(e){return e.filtered||"blend"===$t}).length;t.select("#nodeId-"+e.autoId).select("g.labels").select(".lnLabel").text(a-l+"/"+e.children.size());var d=s,c=r;e.children.values().filter(function(e){return e.filtered||"blend"===$t}).forEach(function(e){e.exaggerated&&(i=te(e,Tt,0),i.x.max-i.x.min>c&&(c=i.x.max-i.x.min),d+=i.y.max-i.y.min)}),t.select("#lBBClipId-"+e.autoId).select("rect").attr("width",c).attr("height",d),t.select("#BBoxId-"+e.autoId).attr("transform","translate("+-c/2+","+-Dt.cell.height/2+")").select("rect").attr("width",c).attr("height",d),n.setNode(e.autoId,{label:e.autoId,width:c,height:d})}()}),e.lLinks.values().forEach(function(e){e.hidden||n.setEdge(e.source.autoId,e.target.autoId,{minlen:1,weight:1,width:0,height:0,labelpos:"r",labeloffset:0})}),e.aLinks.forEach(function(e){if(!e.hidden){var t=e.source.parent.parent.parent.autoId,a=e.target.parent.parent.parent.autoId;e.source.parent.parent.parent.hidden&&(t=e.source.parent.parent.autoId),e.target.parent.parent.parent.hidden&&(a=e.target.parent.parent.autoId),n.setEdge(t,a,{minlen:1,weight:1,width:0,height:0,labelpos:"r",labeloffset:0})}}),a.layout(n),dn=t.map();var d=0,c=0;t.map(n._nodes).values().forEach(function(t){if("undefined"!=typeof t){if(e.lNodes.has(t.label)&&(e.lNodes.get(t.label).filtered||"blend"===$t))!function(){var n=e.lNodes.get(t.label);c=Dt.cell.height,d=Dt.cell.width,n.children.values().filter(function(e){return e.filtered||"blend"===$t}).forEach(function(e){e.exaggerated&&(i=te(e,Tt,0),i.x.max-i.x.min>d&&(d=i.x.max-i.x.min),c+=i.y.max-i.y.min)}),n.x=t.x-Dt.cell.width/2,n.y=t.y-c/2,l=0,o=n.y+Dt.cell.height,n.children.values().filter(function(e){return e.filtered||"blend"===$t}).sort(function(e,t){return e.y-t.y}).forEach(function(e){i=te(e,Tt,0),r=i.x.max-i.x.min,e.x=n.x-r/2+Dt.cell.width/2,e.exaggerated?(e.y=o,o+=te(e,Tt,0).y.max-te(e,Tt,0).y.min):e.y=e.parent.y})}();else{var n=e.aNodes.filter(function(e){return e.autoId===t.label&&(e.filtered||"blend"===$t)})[0];n&&"undefined"!=typeof n&&(i=te(n,Tt,0),d=i.x.max-i.x.min,c=i.y.max-i.y.min,n.x=t.x-d/2,n.y=t.y-c/2)}dn.has(t.x)?dn.get(t.x).nodes.push(t.label):(dn.set(t.x,{nodes:[],width:0}),dn.get(t.x).nodes.push(t.label)),d>dn.get(t.x).width&&(dn.get(t.x).width=d)}}),Dt.graph.lNodes.values().forEach(function(e){ye(e,t.select("#gNodeId-"+e.autoId))}),dn.values().forEach(function(e){e.nodes=e.nodes.sort(function(e,t){return e.y-t.y})})}function je(e,n){var a=this;we(),"s"===n?Ee(e):"p"===n&&Be(e),t.select(".aHLinks").selectAll(".hLink").each(function(e){e.highlighted&&(e.hidden=!1,t.select(a).classed("hiddenLink",!1))}),vn&&ke()}function Ue(n){var a=this,i=[0,0],r=[0,0];Dt.graph.aNodes.forEach(function(e){var t=te(e,Tt,0);t.x.min<i[0]&&(i[0]=t.x.min),t.x.max>r[0]&&(r[0]=t.x.max),t.y.min<i[1]&&(i[1]=t.y.min),t.y.max>r[1]&&(r[1]=t.y.max)});var s=e("#provenance-sidebar").width()-e("#solr-facet-view").width()-parseFloat(e("#main-area").css("margin-left").replace("px","")),l=[r[0]-i[0],r[1]-i[1]],o=[Dt.width/l[0],Dt.height/l[1]],d=.9*t.min(o.concat([3])),c=[(s>0?s:0)+2*Dt.margin.left*d,(Dt.height-l[1]*d)/2+2*Dt.margin.top];Dt.canvas.transition().duration(n).attr("transform","translate("+c+")scale("+d+")"),Dt.zoom.translate(c),Dt.zoom.scale(d),setTimeout(function(){1>d?(t.selectAll(".BBox").classed("hiddenNode",!0),t.selectAll(".lDiff, .aDiff").classed("hiddenNode",!0)):(t.selectAll(".BBox").classed("hiddenNode",!1),t.selectAll(".lDiff, .aDiff").classed("hiddenNode",!1)),1.7>d?(Dt.canvas.selectAll(".anLabel, .sanLabel, .lnLabel, .nodeAttrLabel, .stored-node-type-icon, .an-node-type-icon, .san-node-type-icon, .l-node-type-icon, .lBBoxLabel, .aBBoxLabel, .nodeDoiLabel").classed("hiddenLabel",!0),t.selectAll(".glAnchor, .grAnchor").classed("hiddenNode",!0)):(Dt.canvas.selectAll(".anLabel, .sanLabel, .lnLabel, .nodeAttrLabel, .stored-node-type-icon, .an-node-type-icon, .san-node-type-icon, .l-node-type-icon, .lBBoxLabel, .aBBoxLabel, .nodeDoiLabel").classed("hiddenLabel",!1),t.selectAll(".glAnchor, .grAnchor").classed("hiddenNode",!1))},n),Dt.rect.attr("transform","translate("+-c[0]/d+","+-c[1]/d+") scale("+1/d+")"),Dt.canvas.selectAll(".lBBoxLabel").transition().duration(n).attr("transform","translate("+1*on*Dt.radius+","+.5*on*Dt.radius+") scale("+1/d+")"),Dt.canvas.selectAll(".aBBoxLabel").transition().duration(n).attr("transform","translate("+1*on*Dt.radius+","+0*on*Dt.radius+") scale("+1/d+")"),Dt.canvas.selectAll(".nodeDoiLabel").transition().duration(n).attr("transform","translate(0,"+1.6*on*Dt.radius+") scale("+1/d+")"),Dt.canvas.selectAll(".nodeAttrLabel").transition().duration(n).attr("transform","translate("+-1.5*on*Dt.radius+","+-1.5*on*Dt.radius+") scale("+1/d+")");var u=(Tt.width-2*on*Dt.radius)*t.transform(t.select(".canvas").select("g").select("g").attr("transform")).scale[0];t.selectAll(".node").select(".nodeAttrLabel").each(function(n){var i=""===n.label?n.name:n.label;if("stored"===n.nodeType){var r="";e("#prov-ctrl-visible-attribute-list > li").each(function(){e(this).find("input[type='radio']").prop("checked")&&(r=e(this).find("label").text())}),i=n.attributes.get(r)}if("undefined"!=typeof i){t.select(a).text(i);var s=parseInt(i.length*(u/a.getComputedTextLength()),10);s<i.length&&t.select(a).text(i.substr(0,s-3)+"...")}})}function Me(){var n=this;_t.each(function(n){n.selected=!1,n.doi.selectedChanged(),t.select("#nodeId-"+n.autoId).classed("selectedNode",!1),e("#nodeId-"+n.autoId).find(".glyph").find("rect, circle").css("stroke",un)}),e("#nodeInfoTitle").html("Select a node: - "),e("#nodeInfoTitleLink").html(""),e("#provenance-nodeInfo-content").html(""),Qt=t.map(),e(".filteredNode").hover(function(){e(this).find("rect, circle").css("stroke",fn)},function(){e(n).find("rect, circle").css("stroke",un)})}function He(n){var a=this;Me(),n.selected=!0,W(n,!0),Qt.set(n.autoId,n),t.select("#nodeId-"+n.autoId).classed("selectedNode",n.selected).select(".glyph").select("rect, circle").style("stroke",fn),e("#nodeId-"+n.autoId).hover(function(){e(this).find("rect, circle").css("stroke",fn)},function(){e(a).find("rect, circle").css("stroke",fn)}),n.doi.selectedChanged(),vn&&ke()}function We(){function n(t){e("#provvis-cc-strokes-hex").text(t),jt.style({stroke:t}),_t.style({stroke:t}),e(".glAnchor, .grAnchor").css({stroke:t,fill:t})}function a(t){var n=this;e("#provvis-cc-highlight-hex").text(t),Ft.style({stroke:t}),e(".filteredNode").hover(function(){e(this).find("rect, circle").css({stroke:t})},function(){e(n).find("rect, circle").css({stroke:un})}),e(".glAnchor, .grAnchor").hover(function(){e(this).css({stroke:t,fill:t})},function(){e(n).css({stroke:un,fill:un})})}function i(n){switch(n){case"none":_t.select(".glyph").selectAll("rect, circle").style("fill","#ffffff"),_t.selectAll(".anLabel, .sanLabel, .anwfLabel, .sanwfLabel, .an-node-type-icon, .san-node-type-icon").style("fill","#000000"),Ct.selectAll(".lnLabel, .wfLabel, .l-node-type-icon").style("fill","#000000");break;case"time":Ct.each(function(e){t.select("#nodeId-"+e.autoId).select(".glyph").selectAll("rect").style("fill","url(#layerGradientId-"+e.autoId+")")}),Ct.selectAll(".lnLabel, .wfLabel, .l-node-type-icon").style("fill",function(e){var n=t.min(e.children.values(),function(e){return e.start});return Xt(F(n))<"#888888"?"#ffffff":"#000000"}),Ot.select(".glyph").selectAll("rect, circle").style("fill",function(e){return Xt(F(e.start))}),Ot.selectAll(".anLabel, .anwfLabel, .an-node-type-icon").style("fill",function(e){return Xt(F(e.start))<"#888888"?"#ffffff":"#000000"}),St.select(".glyph").selectAll("rect, circle").style("fill",function(e){return Xt(F(e.parent.start))}),St.selectAll(".sanLabel, .sanwfLabel, .san-node-type-icon").style("fill",function(e){return Xt(F(e.parent.start))<"#888888"?"#ffffff":"#000000"}),zt.select(".glyph").selectAll("rect, circle").style("fill",function(e){return Xt(F(e.parent.parent.start))}),zt.selectAll(".stored-node-type-icon").style("fill",function(e){return Xt(F(e.parent.parent.start))<"#888888"?"#ffffff":"#000000"});break;case"workflow":var a=function(){var n=function(t){return e("#provvis-cc-wf-hex-"+t).text()};return _t.each(function(e){for(var a=e;!(a instanceof c);)a=a.parent;t.select("#nodeId-"+e.autoId).select(".glyph").selectAll("rect, circle").style("fill",n(s.get(a.wfCode)))}),_t.selectAll(".anLabel, .sanLabel, .anwfLabel, .sanwfLabel, .an-node-type-icon, .san-node-type-icon").style("fill","#000000"),Ct.selectAll(".lnLabel, .wfLabel, .l-node-type-icon").style("fill","#000000"),"break"}();if("break"===a)break;case"nodetype":var i=function(){var n=function(t){return e("#provvis-cc-"+t+"-hex").text()};return _t.each(function(e){t.select("#nodeId-"+e.autoId).select(".glyph").selectAll("rect, circle").style("fill",n(e.nodeType))}),_t.selectAll(".anLabel, .sanLabel, .anwfLabel, .sanwfLabel, .an-node-type-icon, .san-node-type-icon").style("fill","#000000"),Ct.selectAll(".lnLabel, .wfLabel, .l-node-type-icon").style("fill","#000000"),zt.selectAll(".stored-node-type-icon").style("fill","#ffffff"),"break"}();if("break"===i)break}}var r=t.scale.category10(),s=t.map();s.set("dataset",0);var l=1;Dt.graph.workflowData.values().forEach(function(e){var t=e.name;"Test workflow: "===e.name.substr(0,15)&&(t=e.name.substr(15,e.name.length-15)),t.indexOf("(")>0&&(t=t.substr(0,t.indexOf("("))),t.indexOf("-")>0&&(t=t.substr(0,t.indexOf("-"))),s.has(t)||(s.set(t,l),l++),e.code=t}),s.entries().forEach(function(t,n){var a=t.key;e("<tr/>",{id:"provvis-cc-wf-tr-"+n}).appendTo("#prov-ctrl-cc-workflow-content"),e("<td/>",{id:"provvis-cc-wf-td-"+n}).appendTo("#provvis-cc-wf-tr-"+n),e("<label/>",{id:"provvis-cc-wf-label-"+n,"class":"provvis-cc-label",html:'<input id="provvis-cc-wf-color-'+n+'" type="text">'+a}).appendTo("#provvis-cc-wf-td-"+n),e("<em/>",{id:"provvis-cc-wf-hex-"+n,"class":"provvis-cc-hide-hex",html:r(t.value)}).appendTo("#provvis-cc-wf-label-"+n),e("#provvis-cc-wf-color-"+n).spectrum({color:r(t.value),showAlpha:!1,change:function(t){e("#provvis-cc-wf-hex-"+n).text(t.toHexString()),i("workflow")}})}),e("#provvis-cc-strokes").spectrum({color:"#136382",showAlpha:!0,change:function(e){un=e.toHexString(),n(un),a(fn)}}),e("#provvis-cc-highlight").spectrum({color:"#ed7407",showAlpha:!0,change:function(e){fn=e.toHexString(),a(fn)}}),e("#provvis-cc-layer").spectrum({color:"#1f77b4",showAlpha:!0,change:function(t){e("#provvis-cc-layer-hex").text(t.toHexString()),i("nodetype")}}),e("#provvis-cc-analysis").spectrum({color:"#2ca02c",showAlpha:!0,change:function(t){e("#provvis-cc-analysis-hex").text(t.toHexString()),i("nodetype")}}),e("#provvis-cc-subanalysis").spectrum({color:"#d62728",showAlpha:!0,change:function(t){e("#provvis-cc-subanalysis-hex").text(t.toHexString()),i("nodetype")}}),e("#provvis-cc-special").spectrum({color:"#17becf",showAlpha:!0,change:function(t){e("#provvis-cc-special-hex").text(t.toHexString()),i("nodetype")}}),e("#provvis-cc-dt").spectrum({color:"#7f7f7f",showAlpha:!0,change:function(t){e("#provvis-cc-dt-hex").text(t.toHexString()),i("nodetype")}}),e("#provvis-cc-intermediate").spectrum({color:"#bcbd22",showAlpha:!0,change:function(t){e("#provvis-cc-intermediate-hex").text(t.toHexString()),i("nodetype")}}),e("#provvis-cc-stored").spectrum({color:"#8c564b",showAlpha:!0,change:function(t){e("#provvis-cc-stored-hex").text(t.toHexString()),i("nodetype")}}),e("[id^=prov-ctrl-cc-none-]").on("click",function(){i("none")}),e("[id^=prov-ctrl-cc-time-]").on("click",function(){i("time")}),e("[id^=prov-ctrl-cc-workflow-]").on("click",function(){i("workflow")}),e("[id^=prov-ctrl-cc-nodetype-]").on("click",function(){i("nodetype")})}function Pe(n){var a=" - ",i=" - ",r=Object.create(null),s=t.map(),l=0,o=0,d=0,c=0,u=0,f=0;switch(n.nodeType){case"raw":case"special":case"intermediate":case"stored":r=Dt.graph.nodeData.get(n.uuid),"undefined"!=typeof r&&(a='<i class="fa fa-sitemap rotate-icon-90"></i>&nbsp;'+n.fileType,i=null!==r.file_url?'<a title="Download linked file" href="'+r.file_url+'" onclick=window.open("'+r.file_url+'")><i class="fa fa-arrow-circle-o-down"></i>&nbsp;'+r.name+"</a>":" - ");break;case"dt":r=Dt.graph.nodeData.get(n.uuid),"undefined"!=typeof r&&(a='<i class="fa fa-sitemap rotate-icon-90"></i>&nbsp;'+n.fileType,null!==r.file_url&&(i='<a title="Download linked file" href="'+r.file_url+'" onclick=window.open("'+r.file_url+'")><i class="fa fa-arrow-circle-o-down"></i>&nbsp;'+r.name+"</a>"));break;case"subanalysis":r=Dt.graph.workflowData.get(n.parent.wfUuid),"undefined"!=typeof r?(a='<i class="fa fa-cog"></i>&nbsp; Analysis Group',i="<a href=/workflows/"+n.wfUuid+' target="_blank">'+n.parent.wfName+"</a>"):a='<i class="fa fa-cog"></i>&nbsp; Dataset',0===n.parent.motifDiff.numIns&&0===n.parent.motifDiff.numOuts&&0===n.parent.motifDiff.numSubanalyses||(n.parent.motifDiff.numIns<0?l+=n.parent.motifDiff.numIns:o+=n.parent.motifDiff.numIns,n.parent.motifDiff.numSubanalyses<0?d+=n.parent.motifDiff.numSubanalyses:c+=n.parent.motifDiff.numSubanalyses,n.parent.motifDiff.numOuts<0?u+=n.parent.motifDiff.numOuts:f+=n.parent.motifDiff.numOuts);break;case"analysis":r=Dt.graph.analysisData.get(n.uuid),"undefined"!=typeof r?(a='<i class="fa fa-cogs"></i>&nbsp; Analysis',i="<a href=/workflows/"+n.wfUuid+' target="_blank">'+n.wfName+"</a>"):a='<i class="fa fa-cogs"></i>&nbsp; Dataset',0===n.motifDiff.numIns&&0===n.motifDiff.numOuts&&0===n.motifDiff.numSubanalyses||(n.motifDiff.numIns<0?l+=n.motifDiff.numIns:o+=n.motifDiff.numIns,n.motifDiff.numSubanalyses<0?d+=n.motifDiff.numSubanalyses:c+=n.motifDiff.numSubanalyses,n.motifDiff.numOuts<0?u+=n.motifDiff.numOuts:f+=n.motifDiff.numOuts);break;case"layer":r={aggregation_count:n.children.size(),workflow:n.wfName,subanalysis_count:n.motif.numSubanalyses,wfUuid:n.motif.wfUuid},"undefined"!=typeof r&&(a='<i class="fa fa-bars"></i>&nbsp; Layer',i="<a href=/workflows/"+r.wfUuid+' target="_blank">'+r.workflow+"</a>"),n.children.values().some(function(e){return 0!==e.motifDiff.numIns||0!==e.motifDiff.numOuts||0!==e.motifDiff.numSubanalyses})&&n.children.values().forEach(function(e){e.motifDiff.numIns<0?l+=e.motifDiff.numIns:o+=e.motifDiff.numIns,e.motifDiff.numSubanalyses<0?d+=e.motifDiff.numSubanalyses:c+=e.motifDiff.numSubanalyses,e.motifDiff.numOuts<0?u+=e.motifDiff.numOuts:f+=e.motifDiff.numOuts})}0===l&&0===o||s.set("Diff: Inputs",l+" "+o),0===d&&0===c||s.set("Diff: Subanalyses",d+" "+c),0===u&&0===f||s.set("Diff: Outputs",u+" "+f),e("#nodeInfoTitle").html(a),e("#nodeInfoTitleLink").html(i),e("#provenance-nodeInfo-content").html(""),s.entries().forEach(function(t){e("<div/>",{"class":"refinery-subheader",html:"<h4>"+t.key+"</h4>"}).appendTo("#provenance-nodeInfo-content"),e("<p/>",{"class":"provvisNodeInfoValue provvisNodeInfoDiff",html:"<i><b>"+t.value+"</b></i>"}).appendTo("#provenance-nodeInfo-content")}),t.entries(r).forEach(function(t){e("<div/>",{"class":"refinery-subheader",html:"<h4>"+t.key+"</h4>"}).appendTo("#provenance-nodeInfo-content"),e("<p/>",{"class":"provvisNodeInfoValue",html:"<i>"+t.value+"</i>"}).appendTo("#provenance-nodeInfo-content")})}function Fe(e){for(var t="dataset",n=e;!(n instanceof l);)n=n.parent;return"undefined"!=typeof Dt.graph.workflowData.get(n.wfUuid)&&(t=Dt.graph.workflowData.get(n.wfUuid).name),t.toString()}function Ge(){function n(e,t){return"<b>"+e+": </b>"+t}var a=this;zt.on("mouseover",function(i){var r=t.select(a),s=n("Name",i.name)+"<br>"+n("Type",i.fileType)+"<br>"+n("File Url",i.fileUrl)+"<br>"+n("UUID",i.uuid)+"<br>";i.attributes.forEach(function(e,t){s+=n(e,t)+"<br>"}),Q(At,s,event),i.parent.parent.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",.3)}),t.select("#BBoxId-"+i.parent.autoId).classed("mouseoverBBox",!0),r.select(".labels").attr("clip-path","");var l=""===i.label?i.name:i.label;if("stored"===i.nodeType){var o="";e("#prov-ctrl-visible-attribute-list > li").each(function(){e(a).find("input[type='radio']").prop("checked")&&(o=e(a).find("label").text())}),l=i.attributes.get(o)}r.select(".nodeAttrLabel").text(l),t.selectAll(".node:not(#nodeId-"+i.autoId+")").selectAll(".nodeAttrLabel").transition().duration(en).attr("opacity",0)}).on("mousemove",function(e){var a=n("Name",e.name)+"<br>"+n("Type",e.fileType)+"<br>"+n("File Url",e.fileUrl)+"<br>"+n("UUID",e.uuid)+"<br>";e.attributes.forEach(function(e,t){a+=n(e,t)+"<br>"}),t.select("#BBoxId-"+e.parent.autoId).classed("mouseoverBBox",!0),Q(At,a,event)}).on("mouseout",function(n){var i=t.select(a);Z(At),n.parent.parent.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",0)}),t.select("#BBoxId-"+n.parent.autoId).classed("mouseoverBBox",!1),i.select(".labels").attr("clip-path","url(#bbClipId-"+n.autoId+")");var r=(Tt.width-2*on*Dt.radius)*t.transform(t.select(".canvas").select("g").select("g").attr("transform")).scale[0],s=""===n.label?n.name:n.label;if("stored"===n.nodeType){var l="";e("#prov-ctrl-visible-attribute-list > li").each(function(){e(a).find("input[type='radio']").prop("checked")&&(l=e(a).find("label").text())}),s=n.attributes.get(l)}if("undefined"!=typeof s){i.select(".nodeAttrLabel").text(s);var o=parseInt(s.length*(r/i.select(".nodeAttrLabel").node().getComputedTextLength()),10);o<s.length&&i.select(".nodeAttrLabel").text(s.substr(0,o-3)+"...")}t.selectAll(".nodeAttrLabel").transition().duration(en).attr("opacity",1)}),St.on("mouseover",function(e){var n=t.select(a);n.select(".labels").attr("clip-path",""),e.parent.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",.3)})}).on("mouseout",function(e){var n=t.select(a);n.select(".labels").attr("clip-path","url(#bbClipId-"+e.autoId+")"),e.parent.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",0)})}),Ot.on("mouseover",function(e){var n=t.select(a);n.select(".labels").attr("clip-path",""),e.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",.3)})}).on("mouseout",function(e){var n=t.select(a);n.select(".labels").attr("clip-path","url(#bbClipId-"+e.autoId+")"),e.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",0)})}),Ct.on("mouseover",function(){var e=t.select(a);e.select(".labels").select(".wfLabel").attr("clip-path","")}).on("mouseout",function(e){var n=t.select(a);n.select(".labels").select(".wfLabel").attr("clip-path","url(#bbClipId-"+e.autoId+")")}),Rt.on("mouseover",function(e){var n=t.select(a);n.classed("mouseoverBBox",!0),e.parent.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",.3)}),n.select(".labels").attr("clip-path","")}).on("mouseout",function(e){var n=t.select(a);n.classed("mouseoverBBox",!1),e.parent.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",0)}),n.select(".labels").attr("clip-path","url(#saBBClipId-"+e.autoId+")")}),Vt.on("mouseover",function(e){var n=t.select(a);n.select(".labels").attr("clip-path",""),e.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",.3)})}).on("mouseout",function(e){var n=t.select(a);n.select(".labels").attr("clip-path","url(#aBBClipId-"+e.autoId+")"),e.parent.children.values().forEach(function(e){t.select("#BBoxId-"+e.autoId).style("stroke-opacity",0)})}),Yt.on("mouseover",function(){var e=t.select(a);e.select(".labels").attr("clip-path","")}).on("mouseout",function(e){var n=t.select(a);n.select(".labels").attr("clip-path","url(#lBBClipId-"+e.autoId+")")}),t.selectAll(".tlAnalysis").on("mouseover",function(e){Q(At,n("Created",F(e.start))+"<br>"+n("Workflow",Fe(e))+"<br>",event),t.select("#BBoxId-"+e.autoId).classed("mouseoverTlBBox",!0)}).on("mousemove",function(e){Q(At,n("Created",F(e.start))+"<br>"+n("Workflow",Fe(e))+"<br>",event)}).on("mouseout",function(e){Z(At),t.select("#BBoxId-"+e.autoId).classed("mouseoverTlBBox",!1)})}function Re(){var e=this;Ct.each(function(e){e.hidden=!0}),Ct.classed("hiddenNode",!0),Ot.each(function(e){e.hidden=!0}),Ot.classed("hiddenNode",!0),St.each(function(e){e.hidden=!0}),St.classed("hiddenNode",!0),zt.each(function(e){e.hidden=!1}),zt.classed("hiddenNode",!1),Rt.each(function(n){n.filtered&&n.children.values().some(function(e){return!e.hidden})?t.select(e).classed("hiddenBBox",!1):t.select(e).classed("hiddenBBox",!0)}),Vt.each(function(n){n.filtered&&n.parent.hidden&&(t.select(e).classed("hiddenBBox",!1),t.select(e).select("text").classed("hiddenLabel",!1))}),Ot.each(function(e){"dataset"===e.uuid?!function(){var n=0;e.children.values().sort(function(e,t){return e.y-t.y}).forEach(function(e){var a=re(e,Tt,0);e.y=n,n+=a.y.max-a.y.min,e.x=0,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)})}():!function(){var n=re(e.children.values()[0],Tt,0);e.children.values().sort(function(e,t){return e.y-t.y}).forEach(function(e,a){e.y=a*(n.y.max-n.y.min),e.x=0,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)})}();var n=te(e,Tt,0);t.selectAll("#BBoxId-"+e.autoId+", #aBBClipId-"+e.autoId).selectAll("rect").attr("width",n.x.max-n.x.min).attr("height",n.y.max-n.y.min),t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),e.filtered||t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0)}),jt.each(function(e){e.hidden=!1}),jt.classed("hiddenLink",!1),jt.each(function(e){e.filtered?(e.hidden=!1,e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1)):"hide"===$t?(e.hidden=!0,t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!0)):(e.hidden=!1,e.highlighted&&t.select("#hLinkId-"+e.autoId).classed("hiddenLink",!1))}),Gt.each(function(e){e.hidden=!0}),Gt.classed("hiddenLink",!0)}function Ve(){Ct.each(function(e){e.hidden=!0}),Ct.classed("hiddenNode",!0),Ot.each(function(e){e.hidden=!0}),Ot.classed("hiddenNode",!0),St.each(function(e){e.hidden=!1}),St.classed("hiddenNode",!1),zt.each(function(e){e.hidden=!0}),zt.classed("hiddenNode",!0),Rt.classed("hiddenBBox",!0),Ot.each(function(e){e.children.values().sort(function(e,t){return e.y-t.y}).forEach(function(e,n){e.y=n*Dt.cell.height,e.x=0,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)});var n=te(e,Tt,0);t.selectAll("#BBoxId-"+e.autoId+", #aBBClipId-"+e.autoId).selectAll("rect").attr("width",Dt.cell.width).attr("height",n.y.max-n.y.min),t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),e.filtered||t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!0)}),Ot.each(function(e){e.links.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("hiddenLink",!0),e.hidden=!0}),e.inputs.values().forEach(function(e){e.predLinks.values().forEach(function(e){t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.hidden=!1})})}),Gt.each(function(e){e.hidden=!0}),Gt.classed("hiddenLink",!0)}function Ye(){Ct.each(function(e){e.hidden=!0}),Ct.classed("hiddenNode",!0),Ot.each(function(e){e.hidden=!1,H(e),e.filtered&&t.select("#BBoxId-"+e.autoId).classed("hiddenBBox",!1),t.selectAll("#BBoxId-"+e.autoId+", #aBBClipId-"+e.autoId).select("rect").attr("width",Dt.cell.width).attr("height",Dt.cell.height),e.children.values().sort(function(e,t){return e.y-t.y}).forEach(function(e,n){e.y=n*Dt.cell.height,e.x=0,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)})}),Ot.classed("hiddenNode",!1),Rt.classed("hiddenBBox",!0),Ot.each(function(e){e.links.values().forEach(function(e){
t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("hiddenLink",!0),e.hidden=!0}),e.inputs.values().forEach(function(e){e.predLinks.values().forEach(function(e){t.select("#linkId-"+e.autoId).classed("hiddenLink",!1),e.hidden=!1})})}),Gt.each(function(e){e.hidden=!0}),Gt.classed("hiddenLink",!0)}function Xe(){var e=this;Ct.each(function(e){e.hidden=!1,H(e),e.children.values().forEach(function(e){e.exaggerated=!1}),e.filtered&&t.select("BBoxId-"+e.autoId).classed("hiddenBBox",!1)}),Ct.classed("hiddenNode",!1),Rt.classed("hiddenBBox",!0),Vt.classed("hiddenBBox",!0),Ot.each(function(e){e.links.values().forEach(function(e){t.selectAll("#linkId-"+e.autoId+", #hLinkId-"+e.autoId).classed("hiddenLink",!0),e.hidden=!0}),e.children.values().sort(function(e,t){return e.y-t.y}).forEach(function(e,n){e.y=n*Dt.cell.height,e.x=0,ue(t.select("#gNodeId-"+e.autoId),e,e.x,e.y)})}),Ut.each(function(e){e.hidden=!0}),Ut.classed("hiddenLink",!0),Gt.each(function(e){e.hidden=!1}),Gt.classed("hiddenLink",!1),t.select(".aHLinks").selectAll(".hLink").each(function(n){n.highlighted&&(n.hidden=!1,t.select(e).classed("hiddenLink",!1))})}function $e(n){var a=this;e("#prov-ctrl-layers-click").click(function(){Xe(),_e(n),hn&&Ue(en)}),e("#prov-ctrl-analyses-click").click(function(){Ye(),_e(n),hn&&Ue(en)}),e("#prov-ctrl-subanalyses-click").click(function(){Ve(),_e(n),hn&&Ue(en)}),e("#prov-ctrl-workflows-click").click(function(){Re(),_e(n),hn&&Ue(en)}),e("#prov-ctrl-filter-action > label").click(function(){$t=e(a).find("input[type='radio']").prop("value"),"timeline"===Jt?be(t.select(".startTimeline").data()[0].time,t.select(".endTimeline").data()[0].time,Dt):Qe(Dt,Kt)}),e("[id^=prov-ctrl-visible-attribute-list-]").click(function(){e(a).find("input[type='radio']").prop("checked",!0);var i=e(a).find("label").text();e("#prov-ctrl-visible-attribute-list > li").each(function(t,n){var a=e(n);a[0].id!=="prov-ctrl-visible-attribute-list-"+i&&a.find("input[type='radio']").prop("checked",!1)}),n.nodes.filter(function(e){return"stored"===e.nodeType}).forEach(function(n){var i=t.select("#nodeId-"+n.autoId),r=(Tt.width-2*on*Dt.radius)*t.transform(t.select(".canvas").select("g").select("g").attr("transform")).scale[0],s=n.name;if("stored"===n.nodeType){var l="";e("#prov-ctrl-visible-attribute-list > li").each(function(){e(a).find("input[type='radio']").prop("checked")&&(l=e(a).find("label").text())}),s=n.attributes.get(l)}if("undefined"!=typeof s){i.select(".nodeAttrLabel").text(s);var o=parseInt(s.length*(r/i.select(".nodeAttrLabel").node().getComputedTextLength()),10);o<s.length&&i.select(".nodeAttrLabel").text(s.substr(0,o-3)+"...")}})}),e("#prov-ctrl-toggle-sidebar").click(function(){e("#prov-ctrl-toggle-sidebar")[0].checked?(e("#provenance-sidebar").animate({left:"20"},en),e("#provvis-sidebar-content").css("height",Dt.canvas.height)):e("#provenance-sidebar").animate({left:"-355"},en)}),e("#prov-ctrl-toggle-fit").click(function(){hn=!!e("#prov-ctrl-toggle-fit")[0].checked})}function Je(e){$e(e);var n=void 0;_t.on("mousedown",function(e){t.event.defaultPrevented||(clearTimeout(n),n=setTimeout(function(){Zt||(He(e),Pe(e))},200))}),_t.on("dblclick",function(e){t.event.defaultPrevented||(clearTimeout(n),pe(e,"e"))});var a=void 0;t.selectAll(".brect, .link, .hLink, .vLine, .hLine",".cell").on("click",function(){t.event.defaultPrevented||(clearTimeout(a),a=setTimeout(function(){we(e.links),Me(),vn&&ke()},200))}),t.selectAll(".brect, .link, .hLink, .vLine, .hLine, .cell").on("dblclick",function(){t.event.defaultPrevented||(clearTimeout(a),Ue(1e3))}),Ge(),Rt.on("click",function(e){Zt||pe(e.children.values()[0],"c")});var i=void 0;Vt.on("click",function(e){t.event.defaultPrevented||(clearTimeout(i),i=setTimeout(function(){Zt||(e.hidden?e.children.values().some(function(e){return e.hidden})?e.children.values().forEach(function(e){pe(e.children.values()[0],"c")}):pe(e.children.values()[0],"c"):pe(e,"c"))},200))}),Vt.on("dblclick",function(e){t.event.defaultPrevented||(clearTimeout(i),Zt||(e.children.values().forEach(function(e){pe(e.children.values()[0],"c")}),pe(e.children.values()[0],"c"),pe(e,"c")))}),Yt.on("click",function(e){t.event.defaultPrevented||Zt||(e.children.values().forEach(function(e){e.children.values().forEach(function(e){pe(e.children.values()[0],"c")}),pe(e.children.values()[0],"c")}),pe(e.children.values()[0],"c"))}),t.selectAll(".glAnchor").on("click",function(e){je(e,"p")}).on("mousedown",t.event.stopPropagation),t.selectAll(".grAnchor").on("click",function(e){je(e,"s")}).on("mousedown",t.event.stopPropagation)}function qe(e,n){var a=0,i=t.max(n,function(e){return t.max([Math.abs(e.motifDiff.numIns),Math.abs(e.motifDiff.numSubanalyses),Math.abs(e.motifDiff.numOuts)],function(e){return e})});pn=t.scale.linear().domain([a,i]).range([0,1]),n.forEach(function(e){e.doi.initLayerDiffComponent(pn(Math.abs(e.motifDiff.numIns)+Math.abs(e.motifDiff.numOuts)+Math.abs(e.motifDiff.numSubanalyses))),e.children.values().forEach(function(t){t.doi.initLayerDiffComponent(e.doi.doiLayerDiff),t.children.values().forEach(function(t){t.doi.initLayerDiffComponent(e.doi.doiLayerDiff)})})}),e.values().forEach(function(e){var n=t.max(e.children.values(),function(e){return e.doi.doiLayerDiff});e.doi.initLayerDiffComponent(n)})}function Ke(e){Dt=e,Tt=e.cell,ln=Dt.graph.lNodes,tn=Dt.graph.aNodes,nn=Dt.graph.saNodes,an=Dt.graph.nodes,sn=Dt.graph.lLinks,rn=Dt.graph.aLinks,Xt=Ae(Dt.graph.aNodes,["white","black"]),ie(Dt.graph.aNodes,Dt),ae(Dt.graph.lNodes),$t="blend",qe(Dt.graph.lNodes,Dt.graph.aNodes),Dt.canvas.append("g").classed("aHLinks",!0),Dt.canvas.append("g").classed("aLinks",!0),Ne(Dt.graph),se(Dt.graph,Dt.cell,ye),Dt.canvas.append("g").classed("lLinks",!0),Dt.canvas.append("g").classed("layers",!0),Te(Dt.graph.lLinks),De(Dt.graph.lNodes),Dt.canvas.append("g").classed("analyses",!0),Ce(),Se(),ze(),_t=ne(["lNode","aNode","saNode","node"]),le(Pt,de,me,xe),le(Ht,de,me,xe),Dt.graph.aNodes.forEach(function(e){pe(e,"c","auto")}),fe(),ce(),ve(),Ie(Dt),Le(),We(),Je(Dt.graph),Ue(0)}function Qe(e,a){var i=[];Jt="facet",a instanceof n&&(e.graph.lNodes=ln,e.graph.aNodes=tn,e.graph.saNodes=nn,e.graph.nodes=an,e.graph.aLinks=rn,e.graph.lLinks=sn,a.getDocumentList().forEach(function(t){i.push(e.graph.nodeMap.get(t.uuid))}),e.graph.nodes.forEach(function(e){-1===i.map(function(e){return e.parent}).indexOf(e.parent)?(e.parent.children.values().forEach(function(e){e.filtered=!1}),e.parent.filtered=!1,e.parent.links.values().forEach(function(e){e.filtered=!1})):!function(){var t=function n(e){e.filtered=!0,e.predLinks.values().forEach(function(t){t.filtered=!0,t.source.parent===e.parent&&n(t.source)})};t(e),e.parent.filtered=!0,e.parent.links.values().forEach(function(e){e.filtered=!0})}(),e.parent.children.values().forEach(function(e){e.doi.filteredChanged()}),e.parent.doi.filteredChanged()}),e.graph.aNodes.forEach(function(e){e.children.values().some(function(e){return e.filtered})?e.filtered=!0:e.filtered=!1,e.doi.filteredChanged()}),e.graph.lNodes.values().forEach(function(e){e.children.values().some(function(e){return e.filtered})?e.filtered=!0:e.filtered=!1,e.doi.filteredChanged()}),e.graph.aLinks.forEach(function(e){e.filtered=!1}),e.graph.aLinks.filter(function(e){return e.source.parent.parent.filtered&&e.target.parent.parent.filtered}).forEach(function(e){e.filtered=!0}),e.graph.lLinks.values().forEach(function(e){e.filtered=!1}),e.graph.lLinks.values().filter(function(e){return e.source.filtered&&e.target.filtered}).forEach(function(e){e.filtered=!0}),"hide"===$t&&!function(){var n=t.map();e.graph.lNodes.entries().forEach(function(e){e.value.filtered&&n.set(e.key,e.value)}),e.graph.lNodes=n,e.graph.aNodes=e.graph.aNodes.filter(function(e){return e.filtered}),e.graph.saNodes=e.graph.saNodes.filter(function(e){return e.filtered}),e.graph.nodes=e.graph.nodes.filter(function(e){return e.filtered}),e.graph.aLinks=e.graph.aLinks.filter(function(e){return e.filtered});var a=t.map();e.graph.lLinks.entries().forEach(function(e){e.value.filtered&&a.set(e.key,e.value)}),e.graph.lLinks=a}(),_e(e.graph),hn&&Ue(en),fe(),ce(),Ne(e.graph),Te(e.graph.lLinks),e.graph.aNodes.forEach(function(e){he(e)}),e.graph.lNodes.values().forEach(function(e){he(e)}),vn&&ke()),Kt=a}function Ze(e){Ke(e)}function et(e,t){Qe(e,t)}function tt(n){var a=t.select("#"+n);e("<p/>",{id:"tlTitle",html:"Analysis Timeline"}).appendTo(a),e("<p/>",{id:"tlThresholdStart","class":"tlThreshold"}).appendTo(a),e("<p/>",{id:"tlCanvas"}).appendTo(a),t.select("#tlCanvas").append("svg").attr("height",80).attr("width",275).style({"margin-top":"0px","margin-bottom":"0px",padding:"0px"}).attr("pointer-events","all"),e("<p/>",{id:"tlThresholdEnd","class":"tlThreshold"}).appendTo(a)}function nt(n){var a=t.select("#"+n);e("<p/>",{id:"doiTitle",html:"Degree-Of-Interest"}).appendTo(a),e("<div/>",{id:"doiVis",style:"width: 100%; height: 300px;"}).appendTo(a),e("<div/>",{id:"doiCanvas",style:"width: 70px; float: left;"}).appendTo("#doiVis"),t.select("#doiCanvas").append("svg").attr("height",300).attr("width",100).style({"margin-top":"0px","margin-left":"0px",padding:"0px"}).attr("pointer-events","all").append("g").append("g").attr("transform","translate(0,0)").append("g"),e("<button/>",{id:"prov-doi-view-apply","class":"btn btn-primary",type:"button",html:"Apply",style:"position: absolute; left: 0px; top: 340px;"}).appendTo(a),e("<label/>",{id:"prov-doi-trigger","class":"prov-doi-view-show-checkbox",style:"display: flex; position: absolute; left: 75px; top: 340px; margin-top: 5px;",html:'<input id="prov-doi-view-trigger-input" type="checkbox" style="margin-right: 3px;">Auto Update'}).appendTo(a),e("<label/>",{id:"prov-doi-view-show","class":"prov-doi-view-show-checkbox",style:"display: flex; position: absolute; left: 180px; top: 340px; margin-top: 5px;",html:'<input id="prov-doi-view-show-input" type="checkbox" style="margin-right: 3px;">Show DOI'}).appendTo(a)}function at(n){var a=t.select("#"+n);e("<p/>",{id:"changeLayerTitle",html:"Change Layering"}).appendTo(a),e("<div/>",{id:"prov-layering-method","class":"btn-group","data-toggle":"buttons-radio"}).appendTo(a),e("<button/>",{id:"prov-layering-strict","class":"btn btn-primary",type:"button",value:"strict",html:"Hard"}).appendTo("#prov-layering-method"),e("<button/>",{id:"prov-layering-weak","class":"active btn btn-primary",type:"button",value:"weak",html:"Soft"}).appendTo("#prov-layering-method")}function it(){e("#provvis-loader").css("display","inline-block")}function rt(){e("#provvis-loader").css("display","none")}function st(n,a,i){it(),gn instanceof f==!1&&!function(){var r="/api/v1/node?study__uuid="+n+"&format=json&limit=0",s=a.filter(function(e){return"SUCCESS"===e.status});t.json(r,function(n,a){var l=Object.create(null),o=Object.create(null),d=Object.create(null),c={top:20,right:10,bottom:20,left:10},u=7,h=t.scale.category20(),p=Object.create(null);tt("provenance-timeline-view"),nt("provenance-doi-view"),at("provenance-layer-change-view");var v={width:5*u,height:3*u},g=e("div#provenance-visualization").width()-10,m=e("div#solr-table-view").height()-25;e("#provenance-sidebar").css("height",m),e("#provvis-sidebar-content").css("max-height",m-13);var y=.75,x="weak";gn=new f("provenance-visualization",l,a,r,o,d,c,g,m,u,h,p,v,x);var b=function(){gn.canvas.attr("transform","translate("+t.event.translate+") scale("+t.event.scale+")"),t.event.scale<1?(t.selectAll(".BBox").classed("hiddenNode",!0),t.selectAll(".lDiff, .aDiff").classed("hiddenNode",!0)):(t.selectAll(".BBox").classed("hiddenNode",!1),t.selectAll(".lDiff, .aDiff").classed("hiddenNode",!1)),t.event.scale<1.7?(gn.canvas.selectAll(".anLabel, .sanLabel, .lnLabel, .nodeAttrLabel, .stored-node-type-icon, .an-node-type-icon, .san-node-type-icon, .l-node-type-icon, .lBBoxLabel, .aBBoxLabel, .nodeDoiLabel").classed("hiddenLabel",!0),t.selectAll(".glAnchor, .grAnchor").classed("hiddenNode",!0)):(gn.canvas.selectAll(".anLabel, .sanLabel, .lnLabel, .nodeAttrLabel, .stored-node-type-icon, .an-node-type-icon, .san-node-type-icon, .l-node-type-icon, .lBBoxLabel, .aBBoxLabel, .nodeDoiLabel").classed("hiddenLabel",!1),t.selectAll(".glAnchor, .grAnchor").classed("hiddenNode",!1)),gn.rect.attr("transform","translate("+-(t.event.translate[0]+gn.margin.left)/t.event.scale+","+-(t.event.translate[1]+gn.margin.top)/t.event.scale+") scale("+1/t.event.scale+")"),gn.canvas.selectAll(".lBBoxLabel").attr("transform","translate("+1*y*gn.radius+","+.5*y*gn.radius+")scale("+1/t.event.scale+")"),gn.canvas.selectAll(".aBBoxLabel").attr("transform","translate("+1*y*gn.radius+","+0*y*gn.radius+")scale("+1/t.event.scale+")"),gn.canvas.selectAll(".nodeDoiLabel").attr("transform","translate(0,"+1.6*y*gn.radius+")scale("+1/t.event.scale+")"),gn.canvas.selectAll(".nodeAttrLabel").attr("transform","translate("+-1.5*y*gn.radius+","+-1.5*y*gn.radius+")scale("+1/t.event.scale+")");var n=(v.width-2*y*gn.radius)*t.event.scale;t.selectAll(".node").select(".nodeAttrLabel").each(function(a){var i=""===a.label?a.name:a.label;if("stored"===a.nodeType){var r="";e("#prov-ctrl-visible-attribute-list > li").each(function(){e(this).find("input[type='radio']").prop("checked")&&(r=e(this).find("label").text())}),i=a.attributes.get(r)}if("undefined"!=typeof i){t.select(this).text(i);var s=parseInt(i.length*(n/this.getComputedTextLength()),10);s<i.length&&t.select(this).text(i.substr(0,s-3)+"...")}})};gn.canvas=t.select("#provenance-canvas").append("svg").attr("width",g).attr("height",m).attr("pointer-events","all").classed("canvas",!0).append("g").call(gn.zoom=t.behavior.zoom().on("zoom",b)).on("dblclick.zoom",null).append("g"),gn.rect=gn.canvas.append("svg:rect").attr("width",g).attr("height",m).classed("brect",!0),gn.graph=T(a,s,i),gn.graph.bclgNodes=M(gn.graph,gn.cell),K(gn.graph,x),Ze(gn),rt();try{e("#prov-layering-method > button").click(function(){x=e(this).prop("value"),it(),e(".aHLinks").remove(),e(".aLinks").remove(),e(".lLinks").remove(),e(".lLink").remove(),e(".layers").remove(),e(".analyses").remove(),e("#provenance-timeline-view").children().remove(),e("#provenance-doi-view").children().remove(),tt("provenance-timeline-view"),ht.set("filtered",.2,!0),ht.set("selected",.2,!0),ht.set("highlighted",.2,!0),ht.set("time",.2,!0),ht.set("diff",.2,!0),nt("provenance-doi-view"),K(gn.graph,x),Ze(gn),rt()})}catch(I){document.getElementById("provenance-canvas").innerHTML+="Layering Error: "+I.message+"<br>"}})}()}function lt(e){et(gn,e)}function ot(){return gn}function dt(e,t,n){st(e,t,n)}function ct(e){lt(e)}function ut(){return ot()}var ft="1.0.0",ht=function(){var e={filtered:{label:"filtered",value:.2,masked:!0},selected:{label:"selected",value:.2,masked:!0},highlighted:{label:"highlighted",value:.2,masked:!0},time:{label:"time",value:.2,masked:!0},diff:{label:"diff",value:.2,masked:!0}};return{set:function(t,n,a){e[t]={label:t.toString(),value:n,masked:a}},get:function(t){return e[t].value},isMasked:function(t){return e[t].masked},factors:e}}();i.prototype.filteredChanged=function(){this.doiFiltered=this.node.filtered?1:.5,this.computeWeightedSum()},i.prototype.selectedChanged=function(){this.doiSelected=this.node.selected?1:0,this.computeWeightedSum()},i.prototype.highlightedChanged=function(){this.doiHighlighted=this.node.highlighted?1:0,this.computeWeightedSum()},i.prototype.initTimeComponent=function(e){this.doiTime=e,this.computeWeightedSum()},i.prototype.initLayerDiffComponent=function(e){this.doiLayerDiff=e,this.computeWeightedSum()},i.prototype.computeMinMax=function(){this.doiMinMax=-1},i.prototype.computeWeightedSum=function(){this.doiWeightedSum=(this.doiFiltered*ht.factors.filtered.value+this.doiSelected*ht.factors.selected.value+this.doiHighlighted*ht.factors.highlighted.value+this.doiTime*ht.factors.time.value+this.doiLayerDiff*ht.factors.diff.value).toFixed(2)},s.prototype=Object.create(r.prototype),s.prototype.constructor=s,l.prototype=Object.create(r.prototype),l.prototype.constructor=l,o.prototype=Object.create(r.prototype),o.prototype.constructor=o,c.prototype=Object.create(r.prototype),c.prototype.constructor=c;var pt=[],vt=[],gt=[],mt=[],yt=[],xt=[],bt=[],It=[],kt=t.map(),Lt=t.map(),wt=t.map(),Bt=t.map(),Et=t.map(),Nt=Object.create(null),At=t.select("body").append("div").attr("class","refinery-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden"),Dt=Object.create(null),Tt=Object.create(null),Ct=Object.create(null),Ot=Object.create(null),St=Object.create(null),zt=Object.create(null),_t=[],jt=Object.create(null),Ut=Object.create(null),Mt=Object.create(null),Ht=Object.create(null),Wt=Object.create(null),Pt=Object.create(null),Ft=Object.create(null),Gt=Object.create(null),Rt=Object.create(null),Vt=Object.create(null),Yt=Object.create(null),Xt=Object.create(null),$t=Object.create(null),Jt="timeline",qt=Object.create(null),Kt=Object.create(null),Qt=t.map(),Zt=!1,en=1e3,tn=[],nn=[],an=[],rn=[],sn=t.map(),ln=t.map(),on=.75,dn=t.map(),cn="bezier1",un="#136382",fn="#ed7407",hn=!0,pn=Object.create(null),vn=!1,gn=Object.create(null),mn={version:ft,run:dt,update:ct,get:ut};return mn}($,d3,SolrResponse,dagre);
//# sourceMappingURL=refinery-prov-vis.min.js.map
